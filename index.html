<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>üÉè Card Games</title>
<style>
/* @import PH·∫¢I ƒë·ª©ng ƒë·∫ßu */
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ===== THEME ===== */
:root {
  --felt:      #2a5c3e; --felt-dark: #1e4530;
  --surface:   rgba(0,0,0,0.25); --surface2: rgba(0,0,0,0.18);
  --card-bg:   #faf8f3; --card-border: #d4c9b0; --card-shadow: rgba(0,0,0,0.35);
  --text:      #e8f5ed; --text-dim: rgba(232,245,237,0.65);
  --accent:    #d4aa50; --red-card: #c0392b;
  --green-btn: #2e7d52; --blue-btn: #1f618d; --danger-btn: #922b21;
  --border:    rgba(255,255,255,0.1);
  --highlight: #4caf6e; --win: #27ae60; --lose: #e74c3c;
}
[data-theme="light"] {
  --felt: #8ab89a; --felt-dark: #6a9e7a;
  --surface: rgba(0,0,0,0.12); --surface2: rgba(0,0,0,0.07);
  --card-bg: #fff; --card-border: #b0a090; --card-shadow: rgba(0,0,0,0.2);
  --text: #1a2e22; --text-dim: rgba(26,46,34,0.6);
  --accent: #8b6200; --border: rgba(0,0,0,0.08);
}

/* ===== BASE ===== */
body {
  font-family: 'DM Sans', 'Segoe UI', sans-serif;
  background: var(--felt);
  background-image:
    radial-gradient(ellipse at 20% 30%, rgba(255,255,255,0.04) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 70%, rgba(0,0,0,0.15) 0%, transparent 60%);
  color: var(--text); min-height: 100dvh;
  overflow-x: hidden; user-select: none;
  -webkit-tap-highlight-color: transparent;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Ccircle cx='1' cy='1' r='0.6' fill='rgba(255,255,255,0.03)'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0;
}

/* ===== SCREENS ===== */
.screen { display: none; width: 100%; min-height: 100dvh; position: relative; z-index: 1; }
.screen.active { display: flex; flex-direction: column; }

/* ===== MENU ===== */
#menu { align-items: center; justify-content: flex-start; gap: 24px; padding: 30px 20px; overflow-y: auto; }
.menu-logo { text-align: center; margin-bottom: 4px; }
.menu-logo h1 {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: clamp(2.2rem, 7vw, 3.5rem); font-weight: 900; color: var(--accent);
  letter-spacing: 0.02em; line-height: 1.1;
  text-shadow: 0 2px 20px rgba(212,170,80,0.4), 0 1px 3px rgba(0,0,0,0.5);
}
.menu-logo .subtitle {
  font-size: 0.9rem; color: var(--text-dim); margin-top: 6px;
  letter-spacing: 0.08em; text-transform: uppercase; font-weight: 500;
}
.menu-cards-row { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
.mode-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  padding: 28px 32px; text-align: center; cursor: pointer;
  width: clamp(200px, 42vw, 260px);
  transition: transform 0.25s cubic-bezier(.34,1.56,.64,1), box-shadow 0.25s;
  backdrop-filter: blur(4px); position: relative; overflow: hidden;
}
.mode-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent); pointer-events: none; }
.mode-card:hover  { transform: translateY(-6px) scale(1.02); box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px var(--accent); }
.mode-card:active { transform: scale(0.98); }
.mode-icon { font-size: 3.2rem; margin-bottom: 14px; display: block; }
.mode-card h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--accent); margin-bottom: 8px; }
.mode-card p  { font-size: 0.83rem; color: var(--text-dim); line-height: 1.5; }
.menu-footer { color: var(--text-dim); font-size: 0.75rem; text-align: center; }

/* Continue bar */
.continue-bar {
  display: flex; gap: 8px; align-items: center; justify-content: center;
  background: var(--surface); border: 1px solid rgba(212,170,80,0.3);
  border-radius: 12px; padding: 10px 18px; flex-wrap: wrap;
}
.continue-bar span { font-size: 0.85rem; color: var(--text-dim); }

/* ===== TOPBAR ===== */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; background: var(--felt-dark);
  border-bottom: 1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  flex-shrink: 0; position: relative; z-index: 10;
}
.topbar-title   { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); font-weight: 700; }
.topbar-actions { display: flex; gap: 6px; align-items: center; }

/* ===== BUTTONS ===== */
.btn {
  border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem; font-weight: 600; cursor: pointer; padding: 9px 18px;
  transition: all 0.18s; color: #fff; background: var(--green-btn);
  letter-spacing: 0.01em; position: relative; overflow: hidden;
}
.btn::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0); transition: background 0.15s; }
.btn:hover::after { background: rgba(255,255,255,0.12); }
.btn:active { transform: scale(0.96); }
.btn.accent { background: var(--accent); color: #1a2e22; font-weight: 700; }
.btn.accent:hover { background: #e8c060; }
.btn.blue   { background: var(--blue-btn); }
.btn.danger { background: var(--danger-btn); }
.btn.sm     { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
.btn:disabled { opacity: 0.38; cursor: not-allowed; transform: none; }
.btn:disabled::after { display: none; }

.icon-btn {
  background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
  color: var(--text); font-size: 0.78rem; padding: 5px 10px; cursor: pointer;
  transition: all 0.18s; font-family: inherit; font-weight: 500;
}
.icon-btn:hover { background: var(--surface2); border-color: var(--accent); }

.lang-btn {
  background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
  color: var(--text); font-size: 0.75rem; padding: 5px 10px; cursor: pointer;
  transition: all 0.18s; font-family: inherit; font-weight: 800; letter-spacing: 0.06em;
}
.lang-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ===== PLAYING CARDS ===== */
.card {
  width: 58px; height: 84px; background: var(--card-bg);
  border: 1.5px solid var(--card-border); border-radius: 8px;
  display: flex; flex-direction: column; align-items: flex-start;
  padding: 4px 5px; cursor: pointer; position: relative; flex-shrink: 0;
  box-shadow: 2px 3px 8px var(--card-shadow);
  transition: transform 0.15s cubic-bezier(.34,1.56,.64,1), box-shadow 0.15s, border-color 0.12s;
  font-size: 0.82rem; font-weight: 700; color: #1a1a1a; font-family: 'DM Sans', sans-serif;
}
.card-top { display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
.card-rank    { font-size: 0.88rem; font-weight: 800; }
.card-suit-sm { font-size: 0.7rem; }
.card-center  { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 1.3rem; pointer-events: none; }
.card-bot     { position: absolute; bottom: 3px; right: 4px; transform: rotate(180deg); display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
.card.red      { color: var(--red-card); }
.card.selected { transform: translateY(-18px) scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.45), 0 0 0 2px var(--accent); border-color: var(--accent); z-index: 20; }
.card.playable { box-shadow: 2px 3px 8px var(--card-shadow), 0 0 0 2px var(--highlight); }
.card.back     { background: linear-gradient(135deg, #1a3a8a, #1e4db8); cursor: default; border-color: #2952c8; }
.card.sm       { width: 36px; height: 52px; font-size: 0.65rem; padding: 2px 3px; border-radius: 5px; cursor: default; }
.card.sm .card-center { font-size: 0.9rem; }
.card.sm .card-rank   { font-size: 0.65rem; }
.card.sm .card-suit-sm{ font-size: 0.55rem; }

/* Card fly-in animation */
@keyframes cardArrival {
  from { opacity: 0; transform: translateY(-55px) scale(0.5) rotate(-12deg); }
  to   { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
}
.card-anim-in { animation: cardArrival 0.32s cubic-bezier(0.34, 1.56, 0.64, 1) both; }

/* ===== TI·∫æN L√äN ===== */
.tl-layout {
  flex: 1; display: grid; grid-template-rows: auto 1fr auto auto;
  gap: 8px; padding: 8px 10px; max-width: 980px; margin: 0 auto; width: 100%;
}
.bots-row { display: flex; gap: 8px; justify-content: center; }
.bot-slot {
  background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
  padding: 8px 10px; flex: 1; max-width: 200px; min-width: 80px;
  transition: box-shadow 0.2s, border-color 0.2s; position: relative;
}
.bot-slot.active-turn { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(212,170,80,0.35), 0 0 20px rgba(212,170,80,0.15); }
.bot-slot.finished    { border-color: var(--highlight); opacity: 0.75; }
.bot-name { font-size: 0.73rem; color: var(--text-dim); margin-bottom: 6px; font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bot-cards-wrap { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; min-height: 30px; align-items: center; }
.finish-badge {
  position: absolute; top: -6px; right: -6px;
  background: var(--accent); color: #1a2e22; font-size: 0.65rem; font-weight: 800;
  border-radius: 50%; width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.play-area {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 14px;
  padding: 12px; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 8px; min-height: 120px;
}
.turn-label { font-size: 0.85rem; font-weight: 600; color: var(--accent); text-align: center; font-family: 'Playfair Display', serif; }
.played-row { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; min-height: 88px; align-items: center; }
.play-hint  { font-size: 0.78rem; color: var(--text-dim); text-align: center; }
.player-area { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 10px; }
.player-label { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 8px; font-weight: 600; }
.hand-scroll { display: flex; overflow-x: auto; padding-bottom: 6px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
.hand-scroll::-webkit-scrollbar { height: 4px; }
.hand-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
.hand-scroll .card { margin-left: -12px; transition: margin 0.15s, transform 0.15s cubic-bezier(.34,1.56,.64,1), box-shadow 0.15s, border-color 0.12s; }
.hand-scroll .card:first-child { margin-left: 0; }
.hand-scroll .card:hover    { z-index: 15; margin-left: -4px; }
.hand-scroll .card.selected { z-index: 20; margin-left: -4px; }
.action-bar { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; padding: 4px 0; }

/* ===== X√å D√ÅCH ===== */
.xd-layout { flex: 1; display: flex; flex-direction: column; gap: 10px; padding: 10px 12px; max-width: 720px; margin: 0 auto; width: 100%; }
.xd-zone { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; text-align: center; }
.xd-zone h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--accent); margin-bottom: 10px; }
.xd-cards-row   { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; min-height: 88px; align-items: center; }
.xd-score-label { margin-top: 8px; font-size: 1rem; font-weight: 700; color: var(--text); }
.xd-center-panel { display: flex; flex-direction: column; gap: 10px; align-items: center; }
.chip-bar { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; text-align: center; font-size: 0.88rem; width: 100%; }
.chip-bar .val { color: var(--accent); font-size: 1.25rem; font-weight: 800; font-family: 'Playfair Display', serif; }
.bet-row       { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.xd-action-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

/* ===== OVERLAYS ===== */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.72); display: flex; align-items: center; justify-content: center; z-index: 300; animation: fadeIn 0.25s ease; backdrop-filter: blur(3px); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.result-box {
  background: var(--felt-dark); border: 1px solid var(--border); border-radius: 20px;
  padding: 36px 40px; text-align: center; max-width: 360px; width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: popIn 0.3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes popIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.result-box .result-title { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 900; margin-bottom: 10px; }
.result-box .result-title.win  { color: var(--win); }
.result-box .result-title.lose { color: var(--lose); }
.result-box .result-title.draw { color: var(--accent); }
.result-box .result-desc { color: var(--text-dim); font-size: 0.92rem; line-height: 1.6; margin-bottom: 20px; }
.result-box .result-btns { display: flex; gap: 10px; justify-content: center; }

.notif {
  position: fixed; top: 64px; left: 50%; transform: translateX(-50%);
  background: rgba(26,46,34,0.92); border: 1px solid var(--border); backdrop-filter: blur(8px);
  color: var(--text); padding: 10px 22px; border-radius: 30px;
  font-size: 0.88rem; font-weight: 600; z-index: 400;
  pointer-events: none; animation: notifPop 2.4s ease forwards; white-space: nowrap;
}
[data-theme="light"] .notif { background: rgba(255,255,255,0.92); }
@keyframes notifPop { 0%{opacity:0;top:55px} 10%{opacity:1;top:64px} 75%{opacity:1} 100%{opacity:0;top:80px} }

/* ===== ROTATE HINT ===== */
#rotate-hint {
  display: none; position: fixed; inset: 0; z-index: 9999;
  background: var(--felt-dark); flex-direction: column;
  align-items: center; justify-content: center; gap: 18px;
  text-align: center; padding: 30px; pointer-events: none;
}
#rotate-hint .ricon { font-size: 4.5rem; animation: rotPh 1.8s ease-in-out infinite; }
@keyframes rotPh { 0%{transform:rotate(0)} 35%{transform:rotate(-90deg)} 65%{transform:rotate(-90deg)} 100%{transform:rotate(0)} }
#rotate-hint h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--accent); }
#rotate-hint p  { color: var(--text-dim); font-size: 0.88rem; line-height: 1.6; max-width: 280px; }
@media (max-width:768px) and (orientation:portrait) { body.in-game #rotate-hint { display: flex; } }

/* ===== RESPONSIVE ===== */
@media (max-width:460px) {
  .card { width: 50px; height: 74px; padding: 3px 4px; }
  .card.sm { width: 28px; height: 40px; }
  .card-center { font-size: 1.1rem; }
  .card.sm .card-center { font-size: 0.75rem; }
  .mode-card { width: 230px; padding: 22px; }
  .result-box { padding: 28px 24px; }
}
@media (orientation:landscape) and (max-height:480px) {
  .tl-layout { gap: 5px; padding: 5px 8px; }
  .play-area { min-height: 90px; padding: 8px; }
  .card { width: 46px; height: 66px; }
  .card.sm { width: 24px; height: 35px; }
  .card-center { font-size: 1rem; }
  .card.sm .card-center { font-size: 0.7rem; }
  #menu { padding: 15px; gap: 15px; }
  .mode-card { padding: 16px 20px; }
  .mode-icon { font-size: 2.2rem; margin-bottom: 8px; }
  .menu-logo h1 { font-size: 2rem; }
}
/* ===== TUTORIAL ===== */
.tut-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.82); backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn 0.2s ease;
}
.tut-box {
  background: var(--felt-dark); border: 1px solid rgba(212,170,80,0.35);
  border-radius: 20px; padding: 28px 30px; max-width: 420px; width: 92%;
  max-height: 90dvh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  animation: popIn 0.28s cubic-bezier(.34,1.56,.64,1);
}
.tut-box h2 {
  font-family: 'Playfair Display', serif; color: var(--accent);
  font-size: 1.35rem; margin-bottom: 16px; text-align: center;
}
.tut-section { margin-bottom: 14px; }
.tut-section h3 {
  font-size: 0.82rem; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 6px;
}
.tut-section p  { font-size: 0.88rem; color: var(--text-dim); line-height: 1.6; }
.tut-section ul { padding-left: 16px; margin: 0; }
.tut-section li { font-size: 0.86rem; color: var(--text-dim); line-height: 1.7; }
.tut-close {
  display: block; width: 100%; margin-top: 18px;
}
/* ===== LOBBY (mode select before TL/XD) ===== */
#lobby { align-items: center; justify-content: center; gap: 20px; padding: 30px 20px; }
.lobby-title {
  font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--accent);
  font-weight: 900; text-align: center;
}
.lobby-sub { font-size: 0.88rem; color: var(--text-dim); text-align: center; }
.lobby-cards { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
.lobby-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
  padding: 24px 28px; text-align: center; cursor: pointer; min-width: 200px;
  transition: transform 0.22s cubic-bezier(.34,1.56,.64,1), box-shadow 0.22s;
}
.lobby-card:hover  { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.35), 0 0 0 1px var(--accent); }
.lobby-card:active { transform: scale(0.97); }
.lobby-card .lc-icon { font-size: 2.6rem; margin-bottom: 12px; }
.lobby-card h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent); margin-bottom: 6px; }
.lobby-card p  { font-size: 0.8rem; color: var(--text-dim); line-height: 1.5; }

/* Online room panel */
.room-panel {
  background: var(--surface); border: 1px solid rgba(212,170,80,0.3);
  border-radius: 14px; padding: 20px 24px; width: 100%; max-width: 380px;
  display: flex; flex-direction: column; gap: 10px; animation: popIn 0.25s cubic-bezier(.34,1.56,.64,1);
}
.room-panel h3 { font-family: 'Playfair Display', serif; color: var(--accent); font-size: 1rem; }
.room-input {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  color: var(--text); font-size: 1rem; padding: 8px 12px; width: 100%;
  font-family: 'DM Sans', sans-serif; outline: none;
}
.room-input:focus { border-color: var(--accent); }
.room-code-display {
  font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 900;
  color: var(--accent); letter-spacing: 0.18em; text-align: center;
  background: var(--surface2); border-radius: 8px; padding: 10px;
}
.room-players { font-size: 0.82rem; color: var(--text-dim); text-align: center; min-height: 1.4em; }
.room-btn-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

/* ===== PH·ªéM / T√Å L·∫¢ ===== */
.ph-layout {
  flex: 1; display: grid; grid-template-rows: auto 1fr auto auto;
  gap: 8px; padding: 8px 10px; max-width: 980px; margin: 0 auto; width: 100%;
}
.ph-center {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 14px;
  padding: 10px 14px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 8px; min-height: 120px;
}
.ph-discard-area {
  display: flex; gap: 18px; align-items: center; justify-content: center; flex-wrap: wrap;
}
.ph-noc {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  font-size: 0.75rem; color: var(--text-dim);
}
.ph-noc-deck {
  width: 58px; height: 84px; background: linear-gradient(135deg, #1a3a8a, #1e4db8);
  border: 1.5px solid #2952c8; border-radius: 8px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; transition: transform 0.15s;
  box-shadow: 2px 3px 8px var(--card-shadow);
}
.ph-noc-deck:hover { transform: translateY(-4px); }
.ph-noc-deck:disabled, .ph-noc-deck[disabled] { opacity: 0.4; cursor: not-allowed; transform: none; }
.ph-round-info { font-size: 0.78rem; color: var(--text-dim); }
.ph-phom-display {
  display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; align-items: flex-start; margin-top: 6px;
}
.ph-phom-group {
  display: flex; gap: 2px; background: rgba(212,170,80,0.1);
  border: 1px solid rgba(212,170,80,0.25); border-radius: 8px; padding: 4px 6px;
}
.ph-deadwood-group {
  display: flex; gap: 2px; background: rgba(231,76,60,0.08);
  border: 1px solid rgba(231,76,60,0.2); border-radius: 8px; padding: 4px 6px;
}
</style>
</head>
<body>

<!-- ROTATE HINT -->
<div id="rotate-hint">
  <div class="ricon">üì±</div>
  <h2 data-i18n="rotateTitle">Xoay m√†n h√¨nh ngang</h2>
  <p  data-i18n="rotateDesc">Game n√†y ch∆°i t·ªët nh·∫•t ·ªü m√†n h√¨nh ngang. H√£y xoay ƒëi·ªán tho·∫°i!</p>
</div>

<!-- MENU -->
<div class="screen active" id="menu">
  <div style="position:absolute;top:14px;right:14px;z-index:5;display:flex;gap:8px">
    <button class="lang-btn" id="menu-lang-btn" onclick="toggleLang()">EN</button>
    <button class="icon-btn" id="menu-theme-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
  </div>
  <div class="menu-logo">
    <div style="font-size:2.8rem;margin-bottom:6px">üÉè</div>
    <h1 data-i18n="menuTitle">Card Games</h1>
    <div class="subtitle" data-i18n="menuSub">Ti·∫øn L√™n ¬∑ X√¨ D√°ch</div>
  </div>
  <div class="menu-cards-row">
    <div class="mode-card" onclick="openLobby('tl')">
      <span class="mode-icon">üÄÑ</span>
      <h2 data-i18n="tlName">Ti·∫øn L√™n Mi·ªÅn Nam</h2>
      <p  data-i18n="tlDesc">52 l√° ¬∑ 4 ng∆∞·ªùi ¬∑ ƒê√°nh h·∫øt b√†i tr∆∞·ªõc</p>
    </div>
    <div class="mode-card" onclick="openLobby('xd')">
      <span class="mode-icon">üÇ°</span>
      <h2 data-i18n="xdName">X√¨ D√°ch</h2>
      <p  data-i18n="xdDesc">Player vs Dealer ¬∑ Kh√¥ng qu√° 21 ƒëi·ªÉm</p>
    </div>
    <div class="mode-card" onclick="startPhom()">
      <span class="mode-icon">üÉè</span>
      <h2 data-i18n="phName">Ph·ªèm ¬∑ T√° L·∫£</h2>
      <p  data-i18n="phDesc">52 l√° ¬∑ 4 ng∆∞·ªùi ¬∑ √çt r√°c th·∫Øng</p>
    </div>
  </div>
  <div class="continue-bar" id="tl-continue-bar" style="display:none">
    <span data-i18n="continueHint">C√≥ v√°n Ti·∫øn L√™n ƒëang d·ªü:</span>
    <button class="btn accent sm" onclick="tlContinue()" data-i18n="continueGame">‚ñ∂ Ti·∫øp t·ª•c</button>
    <button class="btn danger sm"  onclick="tlDeleteSave()" data-i18n="deleteSave">‚úï X√≥a</button>
  </div>
  <div class="menu-footer" data-i18n="menuFooter">¬© 2026 Card Games ¬∑ Offline</div>
</div>

<!-- TI·∫æN L√äN -->
<div class="screen" id="tienlen">
  <div class="topbar">
    <div class="topbar-title" data-i18n="tlName">Ti·∫øn L√™n Mi·ªÅn Nam</div>
    <div class="topbar-actions">
      <button class="icon-btn sfx-btn" onclick="SFX.toggle()">üîä</button>
      <button class="icon-btn" onclick="showTutorial('tl')">‚ùì</button>
      <button class="lang-btn" id="tl-lang-btn" onclick="toggleLang()">EN</button>
      <button class="icon-btn" id="tl-theme-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
      <button class="icon-btn" onclick="goMenu()">üè†</button>
    </div>
  </div>
  <div class="tl-layout">
    <div class="bots-row" id="tl-bots-row"></div>
    <div class="play-area">
      <div class="turn-label" id="tl-turn-label"></div>
      <div class="played-row" id="tl-played-row"></div>
      <div class="play-hint"  id="tl-hint"></div>
    </div>
    <div class="player-area">
      <div class="player-label">
        <span>
          <span data-i18n="you">üë§ B·∫°n</span>&nbsp;¬∑&nbsp;<span id="tl-card-count">13</span>
          <span data-i18n="cards"> l√°</span>
        </span>
        <span id="tl-player-info" style="color:var(--accent)"></span>
      </div>
      <div class="hand-scroll" id="tl-hand"></div>
    </div>
    <div class="action-bar">
      <button class="btn accent" id="tl-play-btn" onclick="tlPlay()" disabled data-i18n="playBtn">ƒê√°nh ‚ñ∂</button>
      <button class="btn danger" id="tl-pass-btn" onclick="tlPass()" disabled data-i18n="passBtn">B·ªè qua ‚úñ</button>
    </div>
  </div>
</div>

<!-- X√å D√ÅCH -->
<div class="screen" id="xidach">
  <div class="topbar">
    <div class="topbar-title" data-i18n="xdName">X√¨ D√°ch</div>
    <div class="topbar-actions">
      <button class="icon-btn sfx-btn" onclick="SFX.toggle()">üîä</button>
      <button class="icon-btn" onclick="showTutorial('xd')">‚ùì</button>
      <button class="lang-btn" id="xd-lang-btn" onclick="toggleLang()">EN</button>
      <button class="icon-btn" id="xd-theme-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
      <button class="icon-btn" onclick="goMenu()">üè†</button>
    </div>
  </div>
  <div class="xd-layout">
    <div class="xd-zone">
      <h3 data-i18n="dealer">ü§ñ Dealer</h3>
      <div class="xd-cards-row" id="xd-dealer-cards"></div>
      <div class="xd-score-label" id="xd-dealer-score"></div>
    </div>
    <div class="xd-center-panel">
      <div class="chip-bar">
        <span data-i18n="chipsLabel">üí∞ Chips:</span>
        <span class="val" id="xd-chips">1000</span>
        &ensp;|&ensp;
        <span data-i18n="betLabel">C∆∞·ª£c:</span>
        <span class="val" id="xd-bet-disp" style="color:#e8b84b">0</span>
      </div>
      <div class="bet-row" id="xd-bet-row">
        <button class="btn sm blue" onclick="xdBet(10)">+10</button>
        <button class="btn sm blue" onclick="xdBet(25)">+25</button>
        <button class="btn sm blue" onclick="xdBet(50)">+50</button>
        <button class="btn sm blue" onclick="xdBet(100)">+100</button>
        <button class="btn sm danger" onclick="xdClearBet()" data-i18n="clear">X√≥a</button>
        <button class="btn sm accent" onclick="xdDeal()"     data-i18n="deal">Chia b√†i üÉè</button>
      </div>
      <div class="xd-action-row" id="xd-game-row" style="display:none">
        <button class="btn accent" onclick="xdHit()"         data-i18n="hit">R√∫t th√™m ‚ûï</button>
        <button class="btn danger" onclick="xdStand()"       data-i18n="stand">D·ª´ng ‚úã</button>

      </div>
    </div>
    <div class="xd-zone">
      <h3 data-i18n="you">üë§ B·∫°n</h3>
      <div class="xd-cards-row" id="xd-player-cards"></div>
      <div class="xd-score-label" id="xd-player-score"></div>
    </div>
  </div>
</div>

<!-- ===== LOBBY ===== -->
<div class="screen" id="lobby">
  <div class="topbar">
    <div class="topbar-title" id="lobby-title">Ch·ªçn ch·∫ø ƒë·ªô</div>
    <div class="topbar-actions">
      <button class="icon-btn" onclick="goMenu()">üè†</button>
    </div>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:24px 16px">
    <div class="lobby-sub" id="lobby-sub"></div>
    <div class="lobby-cards">
      <div class="lobby-card" id="lobby-solo-card" onclick="lobbySolo()">
        <div class="lc-icon">ü§ñ</div>
        <h3 id="lobby-solo-title">Ch∆°i v·ªõi Bot</h3>
        <p id="lobby-solo-desc">M·ªôt m√¨nh ch∆°i v·ªõi m√°y</p>
      </div>
      <div class="lobby-card" id="lobby-online-card" onclick="lobbyShowOnline()">
        <div class="lc-icon">üåê</div>
        <h3 id="lobby-online-title">Ch∆°i Online</h3>
        <p id="lobby-online-desc">T·∫°o ph√≤ng ho·∫∑c v√†o ph√≤ng</p>
      </div>
    </div>
    <div class="room-panel" id="room-panel" style="display:none">
      <h3 id="room-panel-title">T·∫°o ph√≤ng</h3>
      <input class="room-input" id="room-name-input" placeholder="T√™n c·ªßa b·∫°n" maxlength="16">
      <div id="room-code-area" style="display:none">
        <div class="room-code-display" id="room-code-disp">----</div>
        <div class="room-players" id="room-players-info">ƒêang ch·ªù ng∆∞·ªùi ch∆°i...</div>
        <div class="room-btn-row">
          <button class="btn accent" id="room-start-btn" onclick="wsStartGame()" disabled>‚ñ∂ B·∫Øt ƒë·∫ßu</button>
          <button class="btn danger sm" onclick="wsLeave()">R·ªùi ph√≤ng</button>
        </div>
      </div>
      <div id="room-join-area" style="display:none">
        <input class="room-input" id="room-code-input" placeholder="M√£ ph√≤ng (4 k√Ω t·ª±)" maxlength="4" style="text-transform:uppercase;letter-spacing:0.2em">
        <div class="room-btn-row">
          <button class="btn accent" onclick="wsJoin()">V√†o ph√≤ng üö™</button>
        </div>
        <div class="room-players" id="room-join-status"></div>
      </div>
      <div class="room-btn-row">
        <button class="btn sm blue" id="room-create-btn" onclick="wsCreate()">T·∫°o ph√≤ng m·ªõi</button>
        <button class="btn sm" id="room-joinbtn" onclick="showJoinForm()">V√†o ph√≤ng c√≥ s·∫µn</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== PH·ªéM / T√Å L·∫¢ ===== -->
<div class="screen" id="phom">
  <div class="topbar">
    <div class="topbar-title">üÄÑ Ph·ªèm ¬∑ T√° L·∫£</div>
    <div class="topbar-actions">
      <button class="icon-btn sfx-btn" onclick="SFX.toggle()">üîä</button>
      <button class="icon-btn" onclick="showTutorial('ph')">‚ùì</button>
      <button class="lang-btn" id="ph-lang-btn" onclick="toggleLang()">EN</button>
      <button class="icon-btn" id="ph-theme-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
      <button class="icon-btn" onclick="goMenu()">üè†</button>
    </div>
  </div>
  <div class="ph-layout">
    <div class="bots-row" id="ph-bots-row"></div>
    <div class="ph-center">
      <div class="turn-label" id="ph-turn-label">ƒêang chia b√†i...</div>
      <div class="ph-discard-area">
        <div style="text-align:center">
          <div style="font-size:0.72rem;color:var(--text-dim);margin-bottom:4px" id="ph-discard-label">B√†i v·ª´a ƒë√°nh</div>
          <div id="ph-discard-slot" style="min-width:58px;min-height:84px;display:flex;align-items:center;justify-content:center"></div>
        </div>
        <div class="ph-noc">
          <div style="font-size:0.72rem;margin-bottom:2px" id="ph-noc-label">N·ªçc</div>
          <button class="ph-noc-deck" id="ph-draw-btn" onclick="phDraw()">üÇ†</button>
          <div id="ph-noc-count">0 l√°</div>
        </div>
      </div>
      <div class="ph-round-info" id="ph-round-info"></div>
    </div>
    <div class="player-area">
      <div class="player-label">
        <span>üë§ B·∫°n ¬∑ <span id="ph-card-count">9</span> l√°</span>
        <span id="ph-player-info" style="color:var(--accent)"></span>
      </div>
      <div class="hand-scroll" id="ph-hand"></div>
    </div>
    <div class="action-bar">
      <button class="btn accent" id="ph-eat-btn"     onclick="phEat()">ƒÇn ‚úã</button>
      <button class="btn danger" id="ph-discard-btn" onclick="phDoDiscard()">ƒê√°nh ‚ñ∂</button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   I18N ‚Äî khai b√°o TR∆Ø·ªöC m·ªçi th·ª© ƒë·ªÉ t() lu√¥n s·∫µn s√†ng
   ============================================================ */
var LANG = (function () {
  try { return localStorage.getItem('lang') || 'vi'; } catch (e) { return 'vi'; }
})();

var STRINGS = {
  vi: {
    menuTitle:'Card Games', menuSub:'Ti·∫øn L√™n ¬∑ X√¨ D√°ch ¬∑ Ph·ªèm',
    tlName:'Ti·∫øn L√™n Mi·ªÅn Nam', tlDesc:'52 l√° ¬∑ 4 ng∆∞·ªùi ¬∑ ƒê√°nh h·∫øt b√†i tr∆∞·ªõc',
    xdName:'X√¨ D√°ch', xdDesc:'Player vs Dealer ¬∑ Kh√¥ng qu√° 21 ƒëi·ªÉm',
    phName:'Ph·ªèm ¬∑ T√° L·∫£', phDesc:'52 l√° ¬∑ 4 ng∆∞·ªùi ¬∑ √çt r√°c th·∫Øng',
    menuFooter:'¬© {YEAR} Card Games ¬∑ Offline',
    continueHint:'C√≥ v√°n Ti·∫øn L√™n ƒëang d·ªü:',
    continueGame:'‚ñ∂ Ti·∫øp t·ª•c', deleteSave:'‚úï X√≥a v√°n',
    sort:'‚áÖ S·∫Øp x·∫øp', you:'üë§ B·∫°n', cards:' l√°',
    playBtn:'ƒê√°nh ‚ñ∂', passBtn:'B·ªè qua ‚úñ',
    dealer:'ü§ñ Dealer', chipsLabel:'üí∞ Chips:', betLabel:'C∆∞·ª£c:',
    clear:'X√≥a', deal:'Chia b√†i üÉè', hit:'R√∫t th√™m ‚ûï', stand:'D·ª´ng ‚úã',
    doubleDown:'Double ‚Üï',
    rotateTitle:'Xoay m√†n h√¨nh ngang',
    rotateDesc:'Game n√†y ch∆°i t·ªët nh·∫•t ·ªü m√†n h√¨nh ngang. H√£y xoay ƒëi·ªán tho·∫°i!',
    dealing:'ƒêang chia b√†i...', yourTurn:'üéÆ L∆∞·ª£t c·ªßa b·∫°n ‚Äî ch·ªçn b√†i ƒë·ªÉ ƒë√°nh',
    botTurn:'‚è≥ L∆∞·ª£t c·ªßa', gameOver:'üèÅ V√°n k·∫øt th√∫c!',
    emptyTable:'B√†n tr·ªëng ‚Äî l∆∞·ª£t m·ªõi', newGame:'B·∫Øt ƒë·∫ßu v√°n m·ªõi',
    playedBy:'ƒë√°nh:', cardCount:'l√°', outNotif:'ƒë√£ h·∫øt b√†i!',
    selectCards:'Ch·ªçn b√†i ƒë·ªÉ ƒë√°nh!', badCombo:'B·ªô b√†i kh√¥ng h·ª£p l·ªá!',
    notStrong:'B√†i kh√¥ng ƒë·ªß m·∫°nh!', must3S:'L∆∞·ª£t ƒë·∫ßu ph·∫£i ƒë√°nh 3‚ô†!',
    noChips:'Kh√¥ng ƒë·ªß chips!', betFirst:'ƒê·∫∑t c∆∞·ª£c tr∆∞·ªõc!',
    rank1t:'ü•á B·∫°n th·∫Øng!', rank2t:'ü•à H·∫°ng 2 ‚Äî √Å Qu√¢n!',
    rank3t:'ü•â H·∫°ng 3 ‚Äî G·∫ßn r·ªìi!', rank4t:'üò≠ H·∫°ng B√®o!',
    rkL1:'ü•á H·∫°ng 1', rkL2:'ü•à H·∫°ng 2', rkL3:'ü•â H·∫°ng 3', rkL4:'üíÄ H·∫°ng 4',
    youM:'‚Üê B·∫°n', done:'Ho√†n th√†nh!',
    xdBothBJ:'ü§ù C·∫£ hai X√¨ D√°ch ‚Äî H√≤a!', xdYouBJ:'üåü X√¨ D√°ch! B·∫°n th·∫Øng!',
    xdDealerBJ:'üòÆ Dealer X√¨ D√°ch! B·∫°n thua!', xdXiBan:'üÉè X√¨ B√†n! B·ªô ƒë√¥i √Åt!',
    xdNguLinh:'üéâ Ng≈© Linh! B·∫°n th·∫Øng!', xdBust:'üí• Qu·∫Øc! B·∫°n thua!',
    xdDlBust:'üí• Dealer qu·∫Øc! B·∫°n th·∫Øng!',
    xdWin:'B·∫°n th·∫Øng!', xdLose:'B·∫°n thua!', xdDraw:'H√≤a!',
    chipsLeft:'Chips c√≤n:', outOfChips:'H·∫øt chips! Nh·∫≠n 500.',
    xdDouble:'Double Down!',
    score:'ƒêi·ªÉm:', bjLabel:'üåü X√¨ D√°ch!', xiBanLabel:'üÉè X√¨ B√†n!',
    ngLinh:'üéâ Ng≈© Linh!', bust:'üí• Qu·∫Øc!',
    playAgain:'Ch∆°i l·∫°i', home:'üè† Menu',
    phUu:'üéâ √ô! B·∫°n th·∫Øng!', phRounds:'V√≤ng', phOf:'/', phLeft:' c√≤n l·∫°i',
    phYourTurn:'üéÆ L∆∞·ª£t b·∫°n', phBotTurn:'‚è≥ L∆∞·ª£t',
    phDiscard:'ƒë√°nh ra:', phDisPhase:'Ch·ªçn b√†i ƒë·ªÉ ƒë√°nh ra',
    phTakePhase:'ƒÇn ho·∫∑c b·ªëc b√†i', phNoc:'N·ªçc', phGameEnd:'üèÅ V√°n k·∫øt th√∫c!',
    phWin:'ü•á √çt r√°c nh·∫•t ‚Äî B·∫°n th·∫Øng!', phLose:'üòì Thua r·ªìi!',
    phUuOther:' √π r·ªìi!', phDeadwood:'R√°c:', phPts:' ƒëi·ªÉm',
    phEat:'ƒÇn ‚úã', phDiscardBtn:'ƒê√°nh ‚ñ∂', phDrawBtn:'N·ªçc',
    botNames:['Bot 1','Bot 2','Bot 3'],
    playerNames:['B·∫°n','Bot 1','Bot 2','Bot 3'],
    phBotNames:['Bot A','Bot B','Bot C'],
    cnames:{ single:'R√°c', pair:'ƒê√¥i', triple:'S√°m', four:'T·ª© qu√Ω', straight:'S·∫£nh', conspair:'ƒê√¥i th√¥ng' }
  },
  en: {
    menuTitle:'Card Games', menuSub:'Tien Len ¬∑ Blackjack ¬∑ Phom',
    tlName:'Tien Len (Southern)', tlDesc:'52 cards ¬∑ 4 players ¬∑ Empty hand to win',
    xdName:'Blackjack', xdDesc:'Player vs Dealer ¬∑ Do not go over 21',
    phName:'Phom ¬∑ Ta La', phDesc:'52 cards ¬∑ 4 players ¬∑ Least deadwood wins',
    menuFooter:'¬© {YEAR} Card Games ¬∑ Offline',
    continueHint:'Tien Len game in progress:',
    continueGame:'‚ñ∂ Continue', deleteSave:'‚úï Delete',
    sort:'‚áÖ Sort', you:'üë§ You', cards:' cards',
    playBtn:'Play ‚ñ∂', passBtn:'Pass ‚úñ',
    dealer:'ü§ñ Dealer', chipsLabel:'üí∞ Chips:', betLabel:'Bet:',
    clear:'Clear', deal:'Deal üÉè', hit:'Hit ‚ûï', stand:'Stand ‚úã',
    doubleDown:'Double ‚Üï',
    rotateTitle:'Rotate Your Phone',
    rotateDesc:'This game plays best in landscape mode. Please rotate your device!',
    dealing:'Dealing cards...', yourTurn:'üéÆ Your turn ‚Äî select cards to play',
    botTurn:'‚è≥ Turn of', gameOver:'üèÅ Game over!',
    emptyTable:'Table cleared ‚Äî new round', newGame:'New game started',
    playedBy:'played:', cardCount:'cards', outNotif:'is out!',
    selectCards:'Select cards to play!', badCombo:'Invalid combination!',
    notStrong:'Not strong enough!', must3S:'First turn must include 3‚ô†!',
    noChips:'Not enough chips!', betFirst:'Place a bet first!',
    rank1t:'ü•á You Win!', rank2t:'ü•à 2nd Place!',
    rank3t:'ü•â 3rd Place!', rank4t:'üò≠ Last Place!',
    rkL1:'ü•á 1st', rkL2:'ü•à 2nd', rkL3:'ü•â 3rd', rkL4:'üíÄ Last',
    youM:'‚Üê You', done:'Done!',
    xdBothBJ:'ü§ù Both Blackjack ‚Äî Draw!', xdYouBJ:'üåü Blackjack! You win!',
    xdDealerBJ:'üòÆ Dealer Blackjack! You lose!', xdXiBan:'üÉè Double Ace!',
    xdNguLinh:'üéâ Five Card Charlie! You win!', xdBust:'üí• Bust! You lose!',
    xdDlBust:'üí• Dealer busts! You win!',
    xdWin:'You win!', xdLose:'You lose!', xdDraw:'Draw!',
    chipsLeft:'Chips remaining:', outOfChips:'Out of chips! Got 500.',
    xdDouble:'Double Down!',
    score:'Score:', bjLabel:'üåü Blackjack!', xiBanLabel:'üÉè Double Ace!',
    ngLinh:'üéâ Five Card Charlie!', bust:'üí• Bust!',
    playAgain:'Play Again', home:'üè† Menu',
    phUu:'üéâ Phom! You win!', phRounds:'Round', phOf:'/', phLeft:' remaining',
    phYourTurn:'üéÆ Your turn', phBotTurn:'‚è≥ Turn of',
    phDiscard:'discarded:', phDisPhase:'Choose a card to discard',
    phTakePhase:'Take card or draw from deck', phNoc:'Deck', phGameEnd:'üèÅ Game over!',
    phWin:'ü•á Least deadwood ‚Äî You win!', phLose:'üòì You lost!',
    phUuOther:' went out!', phDeadwood:'Deadwood:', phPts:' pts',
    phEat:'Take ‚úã', phDiscardBtn:'Discard ‚ñ∂', phDrawBtn:'Draw',
    botNames:['Bot 1','Bot 2','Bot 3'],
    playerNames:['You','Bot 1','Bot 2','Bot 3'],
    phBotNames:['Bot A','Bot B','Bot C'],
    cnames:{ single:'Single', pair:'Pair', triple:'Triple', four:'Four of a Kind', straight:'Straight', conspair:'Con. Pairs' }
  }
};

function t(key) {
  var s = STRINGS[LANG];
  return (s && s[key] !== undefined) ? s[key] : (STRINGS.vi[key] !== undefined ? STRINGS.vi[key] : key);
}

function applyLang() {
  var yr = new Date().getFullYear();
  document.querySelectorAll('[data-i18n]').forEach(function (el) {
    el.textContent = t(el.dataset.i18n).replace('{YEAR}', yr);
  });
  var nxt = LANG === 'vi' ? 'EN' : 'VI';
  ['menu-lang-btn','tl-lang-btn','xd-lang-btn','ph-lang-btn'].forEach(function (id) {
    var el = document.getElementById(id);
    if (el) el.textContent = nxt;
  });
  var sc = document.querySelector('.screen.active');
  if (sc) {
    if (sc.id === 'tienlen' && TL.hands[0].length > 0) tlRender();
    if (sc.id === 'xidach') xdRender();
    if (sc.id === 'phom' && PH.hands[0].length > 0) phRender();
  }
}

function toggleLang() {
  LANG = LANG === 'vi' ? 'en' : 'vi';
  try { localStorage.setItem('lang', LANG); } catch (e) {}
  applyLang();
}

/* ============================================================
   SOUND SYSTEM ‚Äî Web Audio API, no external files
   ============================================================ */
var SFX = (function () {
  var ctx = null, _muted = false;

  function getCtx() {
    if (!ctx) {
      try { ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {}
    }
    return ctx;
  }

  /* Play a single synthesized tone */
  function tone(freq, dur, type, vol, when) {
    var c = getCtx();
    if (!c || _muted) return;
    if (c.state === 'suspended') c.resume();
    var t0 = when || c.currentTime;
    var osc  = c.createOscillator();
    var gain = c.createGain();
    osc.connect(gain);
    gain.connect(c.destination);
    osc.type = type || 'sine';
    osc.frequency.setValueAtTime(freq, t0);
    gain.gain.setValueAtTime(Math.min(vol || 0.25, 1), t0);
    gain.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }

  var sounds = {
    click:  function (c) { tone(800, 0.04, 'square',   0.12, c.currentTime); },
    select: function (c) { tone(560, 0.07, 'triangle', 0.14, c.currentTime); },
    play: function (c) {
      /* crisp two-tone card slap */
      tone(620, 0.06, 'triangle', 0.3,  c.currentTime);
      tone(420, 0.10, 'triangle', 0.18, c.currentTime + 0.05);
    },
    pass: function (c) {
      tone(320, 0.12, 'sine', 0.2, c.currentTime);
      tone(260, 0.14, 'sine', 0.12, c.currentTime + 0.09);
    },
    deal: function (c) {
      var now = c.currentTime;
      for (var i = 0; i < 5; i++) {
        tone(480 + i * 40, 0.05, 'triangle', 0.12, now + i * 0.055);
      }
    },
    win: function (c) {
      var now = c.currentTime;
      [523, 659, 784, 1047, 1318].forEach(function (f, i) {
        tone(f, 0.35, 'sine', 0.28, now + i * 0.11);
      });
    },
    lose: function (c) {
      var now = c.currentTime;
      [400, 350, 300, 240, 200].forEach(function (f, i) {
        tone(f, 0.28, 'sawtooth', 0.14, now + i * 0.12);
      });
    },
    bj: function (c) {
      var now = c.currentTime;
      [523, 784, 1047, 1175, 1568].forEach(function (f, i) {
        tone(f, 0.42, 'sine', 0.3, now + i * 0.09);
      });
    }
  };

  return {
    play: function (name) {
      var c = getCtx();
      if (!c || _muted) return;
      if (c.state === 'suspended') { c.resume(); }
      if (sounds[name]) sounds[name](c);
    },
    toggle: function () {
      _muted = !_muted;
      document.querySelectorAll('.sfx-btn').forEach(function (el) {
        el.textContent = _muted ? 'üîá' : 'üîä';
      });
    },
    isMuted: function () { return _muted; }
  };
})();

/* ============================================================
   CARD ENGINE
   ============================================================ */
var TL_RANKS  = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
var SUITS_SYM = ['‚ô†','‚ô£','‚ô¶','‚ô•'];
var IS_RED    = [false, false, true, true];

function TCard(rank, suit) { this.rank = rank; this.suit = suit; }
Object.defineProperties(TCard.prototype, {
  val: { get: function () { return this.rank * 4 + this.suit; } },
  rn:  { get: function () { return TL_RANKS[this.rank]; } },
  ss:  { get: function () { return SUITS_SYM[this.suit]; } },
  red: { get: function () { return IS_RED[this.suit]; } }
});

function makeDeck() {
  var d = [];
  for (var s = 0; s < 4; s++) for (var r = 0; r < 13; r++) d.push(new TCard(r, s));
  return d;
}

function shuffle(arr) {
  var a = arr.slice(), i, j, tmp;
  for (i = a.length - 1; i > 0; i--) {
    j = Math.floor(Math.random() * (i + 1));
    tmp = a[i]; a[i] = a[j]; a[j] = tmp;
  }
  return a;
}

/* ===== CARD RENDER ===== */
function elCard(card, opts) {
  opts = opts || {};
  var el = document.createElement('div');
  var cls = 'card';
  if (!opts.back && card.red) cls += ' red';
  if (opts.back) cls += ' back';
  if (opts.sm)   cls += ' sm';
  if (opts.selected) cls += ' selected';
  if (opts.playable && !opts.selected) cls += ' playable';
  if (opts.anim)     cls += ' card-anim-in';
  el.className = cls;
  if (!opts.back) {
    el.innerHTML =
      '<div class="card-top"><div class="card-rank">' + card.rn +
      '</div><div class="card-suit-sm">' + card.ss + '</div></div>' +
      '<div class="card-center">' + card.ss + '</div>' +
      '<div class="card-bot"><div class="card-rank">' + card.rn +
      '</div><div class="card-suit-sm">' + card.ss + '</div></div>';
  }
  return el;
}

/* ============================================================
   TI·∫æN L√äN ‚Äî COMBO LOGIC
   ============================================================ */
function cmpCard(a, b) { return a.val - b.val; }
function sortC(arr) { return arr.slice().sort(cmpCard); }

function detectCombo(sel) {
  var cards = sortC(sel), n = cards.length;
  if (!n) return null;
  if (n === 1) return { type:'single', cards:cards, rank:cards[0].rank, suit:cards[0].suit };

  var allSame = true;
  for (var ki = 0; ki < n; ki++) if (cards[ki].rank !== cards[0].rank) { allSame = false; break; }
  if (allSame) {
    if (n === 2) return { type:'pair',   cards:cards, rank:cards[0].rank, ts:cards[1].suit };
    if (n === 3) return { type:'triple', cards:cards, rank:cards[0].rank };
    if (n === 4) return { type:'four',   cards:cards, rank:cards[0].rank };
    return null;
  }
  /* No 2s in sequences */
  for (var k2 = 0; k2 < n; k2++) if (cards[k2].rank === 12) return null;

  /* Consecutive pairs */
  if (n >= 4 && n % 2 === 0) {
    var cpOk = true, cpRanks = [], ci;
    for (ci = 0; ci < n; ci += 2) {
      if (cards[ci].rank !== cards[ci+1].rank) { cpOk = false; break; }
      cpRanks.push(cards[ci].rank);
    }
    if (cpOk) {
      var seqOk = true;
      for (ci = 1; ci < cpRanks.length; ci++) if (cpRanks[ci] !== cpRanks[ci-1]+1) { seqOk = false; break; }
      if (seqOk) return { type:'conspair', cards:cards, len:n/2, topRank:cards[n-1].rank, ts:cards[n-1].suit };
    }
  }
  /* Straight */
  if (n >= 3) {
    var stOk = true;
    for (var si = 1; si < n; si++) if (cards[si].rank !== cards[si-1].rank+1) { stOk = false; break; }
    if (stOk) return { type:'straight', cards:cards, len:n, topRank:cards[n-1].rank, ts:cards[n-1].suit };
  }
  return null;
}

function canBeat(a, b) {
  if (!b) return true;
  if (a.type === 'four') {
    if (b.type === 'four')     return a.rank > b.rank;
    if (b.type === 'single'   && b.rank === 12) return true;
    if (b.type === 'conspair' && b.len  <= 3)   return true;
    return false;
  }
  if (a.type === 'conspair') {
    if (b.type === 'conspair') {
      if (a.len !== b.len) return a.len > b.len;
      return a.topRank > b.topRank || (a.topRank === b.topRank && a.ts > b.ts);
    }
    if (b.type === 'single' && b.rank === 12) return a.len >= 3;
    if (b.type === 'pair'   && b.rank === 12) return a.len >= 4;
    return false;
  }
  if (a.type !== b.type) return false;
  if (a.type === 'single')   return a.rank > b.rank || (a.rank === b.rank && a.suit > b.suit);
  if (a.type === 'pair')     return a.rank > b.rank || (a.rank === b.rank && a.ts   > b.ts);
  if (a.type === 'triple')   return a.rank > b.rank;
  if (a.type === 'straight') return a.len === b.len && (a.topRank > b.topRank || (a.topRank === b.topRank && a.ts > b.ts));
  return false;
}

/*
  validPlays ‚Äî optimised: structured enumeration by rank groups + consecutive runs.
  No brute-force combination search; still enumerates ALL valid plays for highlighting.
*/
function validPlays(hand, against) {
  var results = [];

  /* Group hand by rank */
  var byRank = {};
  hand.forEach(function (c) {
    if (!byRank[c.rank]) byRank[c.rank] = [];
    byRank[c.rank].push(c);
  });

  /* Sort each group by suit (ascending) for deterministic output */
  Object.keys(byRank).forEach(function (r) { byRank[r].sort(cmpCard); });

  /* --- SINGLES --- */
  hand.forEach(function (c) {
    var combo = { type:'single', cards:[c], rank:c.rank, suit:c.suit };
    if (canBeat(combo, against)) results.push(combo);
  });

  /* --- SAME-RANK GROUPS: pairs / triples / fours --- */
  Object.keys(byRank).forEach(function (rStr) {
    var r = parseInt(rStr, 10);
    var grp = byRank[r]; /* sorted by suit */

    /* All unique pairs from this group */
    if (grp.length >= 2) {
      for (var ai = 0; ai < grp.length - 1; ai++) {
        for (var bi = ai + 1; bi < grp.length; bi++) {
          var pCards = [grp[ai], grp[bi]]; /* already sorted */
          var pc = { type:'pair', cards:pCards, rank:r, ts:pCards[1].suit };
          if (canBeat(pc, against)) results.push(pc);
        }
      }
    }
    if (grp.length >= 3) {
      var tc = { type:'triple', cards:grp.slice(0,3), rank:r };
      if (canBeat(tc, against)) results.push(tc);
    }
    if (grp.length >= 4) {
      var fc = { type:'four', cards:grp.slice(), rank:r };
      if (canBeat(fc, against)) results.push(fc);
    }
  });

  /* Sorted non-2 ranks present in hand */
  var nRanks = Object.keys(byRank).map(Number).filter(function (r) { return r !== 12; }).sort(function (a, b) { return a - b; });

  /* --- STRAIGHTS ---
     For each start position, extend the consecutive run as long as possible.
     For each valid run of length >= 3, try all suit options for the TOP card. */
  for (var sti = 0; sti < nRanks.length; sti++) {
    /* Cards representing each rank in the current run (take [0] for non-top) */
    var runParts = [byRank[nRanks[sti]][0]];

    for (var eni = sti + 1; eni < nRanks.length; eni++) {
      if (nRanks[eni] !== nRanks[eni - 1] + 1) break; /* gap ‚Äî stop extending */
      runParts.push(byRank[nRanks[eni]][0]);           /* placeholder for this rank */

      if (runParts.length >= 3) {
        var topRnk = nRanks[eni];
        /* Try each card of the top rank as the actual top (different suits) */
        byRank[topRnk].forEach(function (topCard) {
          var stCards = sortC(runParts.slice(0, runParts.length - 1).concat([topCard]));
          var sc = { type:'straight', cards:stCards, len:stCards.length, topRank:topRnk, ts:topCard.suit };
          if (canBeat(sc, against)) results.push(sc);
        });
      }
    }
  }

  /* --- CONSECUTIVE PAIRS ---
     Only ranks that have >= 2 cards, no 2s. */
  var pRanks = nRanks.filter(function (r) { return byRank[r].length >= 2; });

  for (var psi = 0; psi < pRanks.length; psi++) {
    /* Accumulate pairs rank by rank */
    var cpBase = byRank[pRanks[psi]].slice(0, 2); /* first pair of this rank */

    for (var pei = psi + 1; pei < pRanks.length; pei++) {
      if (pRanks[pei] !== pRanks[pei - 1] + 1) break;
      var topPR    = pRanks[pei];
      var topPGrp  = byRank[topPR]; /* >= 2 cards */
      var numPairs = pei - psi + 1;

      /* For top pair, try all suit combinations (affects ts comparison key) */
      for (var tpi = 0; tpi < topPGrp.length - 1; tpi++) {
        for (var tpj = tpi + 1; tpj < topPGrp.length; tpj++) {
          var topPair = [topPGrp[tpi], topPGrp[tpj]]; /* sorted by suit already */
          var cpCards = sortC(cpBase.concat(topPair));
          var cpc = { type:'conspair', cards:cpCards, len:numPairs, topRank:topPR, ts:cpCards[cpCards.length-1].suit };
          if (canBeat(cpc, against)) results.push(cpc);
        }
      }

      /* Extend base for next iteration: add this rank's first pair */
      cpBase = cpBase.concat(byRank[topPR].slice(0, 2));
    }
  }

  return results;
}

/* Cache valid plays for current player turn ‚Äî cleared on every state change */
var _vpCache = null;
function getPlayerValidPlays() {
  var mySlot = _wsOnline ? _wsMyIndex : 0;
  if (!_vpCache) _vpCache = validPlays(TL.hands[mySlot], TL.lastCombo);
  return _vpCache;
}
function clearVPCache() { _vpCache = null; }

/* ============================================================
   TI·∫æN L√äN ‚Äî STATE
   ============================================================ */
var TL = {
  hands: [[],[],[],[]], currentTurn:0,
  lastCombo:null, lastBy:-1, passCount:0,
  selected:[], finished:[], gameOver:false
};
var MEDALS = ['ü•á','ü•à','ü•â','üíÄ'];

/* ============================================================
   TI·∫æN L√äN ‚Äî SAVE / LOAD / CONTINUE
   ============================================================ */
function tlSave() {
  if (TL.gameOver) { tlClearSave(); return; }
  var state = {
    hands: TL.hands.map(function (h) {
      return h.map(function (c) { return { r: c.rank, s: c.suit }; });
    }),
    currentTurn: TL.currentTurn,
    lastBy:      TL.lastBy,
    passCount:   TL.passCount,
    finished:    TL.finished.slice(),
    lastCombo: TL.lastCombo ? {
      type:    TL.lastCombo.type,
      cards:   TL.lastCombo.cards.map(function (c) { return { r:c.rank, s:c.suit }; }),
      rank:    TL.lastCombo.rank,
      suit:    TL.lastCombo.suit,
      ts:      TL.lastCombo.ts,
      len:     TL.lastCombo.len,
      topRank: TL.lastCombo.topRank
    } : null
  };
  try { localStorage.setItem('tl_save', JSON.stringify(state)); } catch (e) {}
}

function tlLoad() {
  try {
    var raw = localStorage.getItem('tl_save');
    if (!raw) return false;
    var st = JSON.parse(raw);
    TL.hands       = st.hands.map(function (h) { return h.map(function (c) { return new TCard(c.r, c.s); }); });
    TL.currentTurn = st.currentTurn;
    TL.lastBy      = st.lastBy;
    TL.passCount   = st.passCount;
    TL.finished    = st.finished || [];
    TL.selected    = [];
    TL.gameOver    = false;
    if (st.lastCombo) {
      var lc = st.lastCombo;
      TL.lastCombo = {
        type:    lc.type,
        cards:   lc.cards.map(function (c) { return new TCard(c.r, c.s); }),
        rank:    lc.rank, suit: lc.suit, ts: lc.ts,
        len:     lc.len,  topRank: lc.topRank
      };
    } else {
      TL.lastCombo = null;
    }
    return true;
  } catch (e) { return false; }
}

function tlClearSave() {
  try { localStorage.removeItem('tl_save'); } catch (e) {}
  checkContinue();
}

function tlContinue() {
  SFX.play('deal');
  if (tlLoad()) {
    showScreen('tienlen');
    clearVPCache();
    tlRender();
    if (isBotTurn()) setTimeout(tlBotTurn, 900);
  } else {
    tlClearSave();
    startTienLen();
  }
}

function tlDeleteSave() {
  tlClearSave();
  notify(LANG === 'vi' ? 'ƒê√£ x√≥a v√°n c≈©' : 'Save deleted');
}

function checkContinue() {
  var has = false;
  try { has = !!localStorage.getItem('tl_save'); } catch (e) {}
  var bar = document.getElementById('tl-continue-bar');
  if (bar) bar.style.display = has ? 'flex' : 'none';
}

/* ============================================================
   TI·∫æN L√äN ‚Äî INIT
   ============================================================ */
function tlInit() {
  _wsOnline = false; _wsMyIndex = 0; _wsHumanSlots = [0];
  var deck = shuffle(makeDeck()), i;
  TL.hands = [[],[],[],[]];
  TL.finished = []; TL.selected = [];
  TL.lastCombo = null; TL.lastBy = -1;
  TL.passCount = 0;   TL.gameOver = false;

  for (i = 0; i < 52; i++) TL.hands[i % 4].push(deck[i]);
  TL.hands.forEach(function (h) { h.sort(cmpCard); });

  /* Find player with 3‚ô† (rank 0, suit 0) */
  TL.currentTurn = 0;
  outer: for (var p = 0; p < 4; p++) {
    for (i = 0; i < TL.hands[p].length; i++) {
      if (TL.hands[p][i].rank === 0 && TL.hands[p][i].suit === 0) {
        TL.currentTurn = p; break outer;
      }
    }
  }

  clearVPCache();
  tlClearSave();
  SFX.play('deal');
  tlRender();
  var lbl = document.getElementById('tl-turn-label');
  if (lbl) lbl.textContent = t('dealing');
  if (TL.currentTurn !== 0) setTimeout(tlBotTurn, 1000);
}

/* ============================================================
   TI·∫æN L√äN ‚Äî RENDER
   ============================================================ */
function tlRender() { tlRenderBots(); tlRenderPlayed(); tlRenderHand(); tlUpdateButtons(); }

function tlRenderBots() {
  var row    = document.getElementById('tl-bots-row');
  var mySlot = _wsOnline ? _wsMyIndex : 0;
  row.innerHTML = '';
  for (var i = 0; i < 4; i++) {
    if (i === mySlot) continue; /* skip local player's own slot */
    var isDone   = TL.finished.indexOf(i) !== -1;
    var isActive = TL.currentTurn === i && !isDone;
    var slot = document.createElement('div');
    slot.className = 'bot-slot' + (isActive ? ' active-turn' : '') + (isDone ? ' finished' : '');
    if (isDone) {
      var badge = document.createElement('div');
      badge.className = 'finish-badge';
      badge.textContent = MEDALS[TL.finished.indexOf(i)];
      slot.appendChild(badge);
    }
    var nameEl = document.createElement('div');
    nameEl.className = 'bot-name';
    /* Show human name if this slot is a real player, else bot name */
    var isHuman = _wsOnline && _wsHumanSlots.indexOf(i) !== -1;
    var slotName = isHuman
      ? (TL.playerNames ? TL.playerNames[i] : ('P' + (i+1)))
      : t('botNames')[i > mySlot ? i - 1 : i];
    if (isActive) slotName += ' ‚è≥';
    nameEl.textContent = slotName + ' ¬∑ ' + TL.hands[i].length + ' ' + t('cardCount');
    slot.appendChild(nameEl);
    var wrap = document.createElement('div');
    wrap.className = 'bot-cards-wrap';
    (function (hand, done, human) {
      /* Show card faces for finished players; backs otherwise (humans also get backs) */
      hand.forEach(function (card) { wrap.appendChild(elCard(card, { back: !done, sm: true })); });
    })(TL.hands[i], isDone, isHuman);
    slot.appendChild(wrap);
    row.appendChild(slot);
  }
}

/* Track whether the last play was NEW (to animate cards) */
var _tlAnimPlayed = false;

function tlRenderPlayed() {
  var label = document.getElementById('tl-turn-label');
  var row   = document.getElementById('tl-played-row');
  var hint  = document.getElementById('tl-hint');
  row.innerHTML = '';

  if (TL.lastCombo) {
    var anim = _tlAnimPlayed;
    TL.lastCombo.cards.forEach(function (c) {
      row.appendChild(elCard(c, { anim: anim }));
    });
    _tlAnimPlayed = false; /* consume flag */
    var cn = t('cnames');
    hint.textContent = t('playerNames')[TL.lastBy] + ' ' + t('playedBy') + ' ' + (cn[TL.lastCombo.type] || '');
  } else {
    hint.textContent = TL.passCount > 0 ? t('emptyTable') : t('newGame');
  }

  if (TL.gameOver) {
    label.textContent = t('gameOver');
  } else if (TL.finished.indexOf(TL.currentTurn) !== -1) {
    label.textContent = '';
  } else {
    var mySlot = _wsOnline ? _wsMyIndex : 0;
    label.textContent = TL.currentTurn === mySlot
      ? t('yourTurn')
      : t('botTurn') + ' ' + t('playerNames')[TL.currentTurn] + '...';
  }
}

function tlRenderHand() {
  var mySlot   = _wsOnline ? _wsMyIndex : 0;
  var handEl   = document.getElementById('tl-hand');
  handEl.innerHTML = '';
  var myActive = TL.currentTurn === mySlot && TL.finished.indexOf(mySlot) === -1 && !TL.gameOver;

  /* Use cached valid plays */
  var playableSet = [];
  if (myActive) {
    getPlayerValidPlays().forEach(function (combo) {
      combo.cards.forEach(function (card) {
        if (playableSet.indexOf(card) === -1) playableSet.push(card);
      });
    });
  }

  TL.hands[mySlot].forEach(function (card) {
    var isSel = TL.selected.indexOf(card) !== -1;
    var isPl  = playableSet.indexOf(card) !== -1;
    var el    = elCard(card, { selected: isSel, playable: isPl });
    if (myActive) {
      (function (c) { el.addEventListener('click', function () { tlToggleCard(c); }); })(card);
    }
    handEl.appendChild(el);
  });

  document.getElementById('tl-card-count').textContent = TL.hands[mySlot].length;
  var idxMe = TL.finished.indexOf(mySlot);
  document.getElementById('tl-player-info').textContent = idxMe !== -1 ? MEDALS[idxMe] + ' ' + t('done') : '';
}

function tlUpdateButtons() {
  var mySlot = _wsOnline ? _wsMyIndex : 0;
  var myTurn = TL.currentTurn === mySlot && TL.finished.indexOf(mySlot) === -1 && !TL.gameOver;
  document.getElementById('tl-play-btn').disabled = !myTurn || TL.selected.length === 0;
  document.getElementById('tl-pass-btn').disabled = !myTurn || !TL.lastCombo;
}

/* ============================================================
   TI·∫æN L√äN ‚Äî PLAYER ACTIONS
   ============================================================ */
function tlToggleCard(card) {
  SFX.play('select');
  var idx = TL.selected.indexOf(card);
  if (idx === -1) TL.selected.push(card); else TL.selected.splice(idx, 1);
  tlRenderHand(); tlUpdateButtons();
}

function tlSortHand() {
  SFX.play('click');
  TL.hands[0].sort(cmpCard); TL.selected = [];
  tlRenderHand(); tlUpdateButtons();
}

function tlPlay() {
  var mySlot = _wsOnline ? _wsMyIndex : 0;
  if (TL.currentTurn !== mySlot) return;
  if (!TL.selected.length) { notify(t('selectCards')); return; }
  var combo = detectCombo(TL.selected);
  if (!combo) { notify(t('badCombo')); return; }
  if (!canBeat(combo, TL.lastCombo)) { notify(t('notStrong')); return; }
  /* First-play 3‚ô† rule */
  if (!TL.lastCombo && TL.lastBy === -1) {
    var h3s = false, s3s = false, hi;
    for (hi = 0; hi < TL.hands[mySlot].length; hi++) if (TL.hands[mySlot][hi].rank===0 && TL.hands[mySlot][hi].suit===0) { h3s=true; break; }
    for (hi = 0; hi < TL.selected.length; hi++) if (TL.selected[hi].rank===0 && TL.selected[hi].suit===0) { s3s=true; break; }
    if (h3s && !s3s) { notify(t('must3S')); return; }
  }
  SFX.play('play');
  /* Send to server when online */
  if (_wsOnline) {
    wsSend({ type: 'move', action: 'play', combo: {
      type: combo.type, rank: combo.rank, suit: combo.suit,
      ts: combo.ts, len: combo.len, topRank: combo.topRank,
      cards: combo.cards.map(function (c) { return { r: c.rank, s: c.suit }; })
    }});
  }
  tlDoPlay(mySlot, combo);
}

function tlPass() {
  var mySlot = _wsOnline ? _wsMyIndex : 0;
  if (TL.currentTurn !== mySlot || !TL.lastCombo) return;
  SFX.play('pass');
  if (_wsOnline) wsSend({ type: 'move', action: 'pass' });
  tlDoPass(mySlot);
}

/* ============================================================
   TI·∫æN L√äN ‚Äî CORE TURN ENGINE
   ============================================================ */
function tlNextActive(from) {
  var next = (from + 1) % 4;
  for (var step = 0; step < 4; step++) { /* 'step' not 't' ‚Äî never shadow t() */
    if (TL.finished.indexOf(next) === -1) return next;
    next = (next + 1) % 4;
  }
  return from; /* fallback: all finished */
}

function isBotTurn() {
  if (TL.gameOver) return false;
  if (TL.finished.indexOf(TL.currentTurn) !== -1) return false;
  /* Online: human slots are NOT bots */
  if (_wsOnline && _wsHumanSlots.indexOf(TL.currentTurn) !== -1) return false;
  /* Offline: slot 0 is the local player */
  if (!_wsOnline && TL.currentTurn === 0) return false;
  return true;
}

function tlDoPlay(pid, combo) {
  /* Remove played cards from hand */
  combo.cards.forEach(function (card) {
    var idx = TL.hands[pid].indexOf(card);
    if (idx !== -1) TL.hands[pid].splice(idx, 1);
  });
  TL.lastCombo = combo; TL.lastBy = pid; TL.passCount = 0; TL.selected = [];
  clearVPCache();

  /* Animate the newly played cards */
  _tlAnimPlayed = true;

  /* Check if this player emptied their hand */
  if (TL.hands[pid].length === 0 && TL.finished.indexOf(pid) === -1) {
    TL.finished.push(pid);
    notify(t('playerNames')[pid] + ' ' + t('outNotif') + ' ' + MEDALS[TL.finished.length - 1]);
    var active = [0,1,2,3].filter(function (p) { return TL.finished.indexOf(p) === -1; });
    if (active.length <= 1) {
      if (active.length === 1) TL.finished.push(active[0]);
      TL.gameOver = true;
      tlClearSave();
      tlRender();
      if (pid === 0 || (TL.finished.length > 0 && TL.finished[0] === 0)) SFX.play('win');
      else SFX.play('lose');
      setTimeout(tlShowResult, 800);
      return;
    }
  }

  tlSave(); /* persist mid-game state */
  tlNextTurn();
}

function tlNextTurn() {
  TL.currentTurn = tlNextActive(TL.currentTurn);
  tlRender();
  if (isBotTurn()) setTimeout(tlBotTurn, 900);
}

function tlDoPass(pid) {
  TL.passCount++;
  clearVPCache();
  var active    = [0,1,2,3].filter(function (p) { return TL.finished.indexOf(p) === -1; });
  var lastByOut = TL.finished.indexOf(TL.lastBy) !== -1;

  /* Threshold: if round-winner already finished, ALL remaining must pass;
     otherwise only the OTHER active players need to pass. */
  var threshold = lastByOut ? active.length : active.length - 1;

  if (TL.passCount >= threshold) {
    /* New round */
    TL.passCount = 0; TL.lastCombo = null;
    TL.currentTurn = lastByOut ? tlNextActive(TL.lastBy) : TL.lastBy;
    tlSave();
    tlRender();
    if (isBotTurn()) setTimeout(tlBotTurn, 800);
  } else {
    TL.currentTurn = tlNextActive(pid);
    tlSave();
    tlRender();
    if (isBotTurn()) setTimeout(tlBotTurn, 800);
  }
}

/* ============================================================
   TI·∫æN L√äN ‚Äî SMART BOT AI
   ============================================================ */

/*
  Hand analysis: mark which cards are part of valuable combos
  so the bot avoids breaking them unnecessarily.
*/
function analyzeHand(hand) {
  var valuable = {}; /* key = rank+'_'+suit */

  var byRank = {};
  hand.forEach(function (c) {
    if (!byRank[c.rank]) byRank[c.rank] = [];
    byRank[c.rank].push(c);
  });

  /* Cards in pairs / triples / fours are valuable */
  Object.keys(byRank).forEach(function (r) {
    if (byRank[r].length >= 2) {
      byRank[r].forEach(function (c) { valuable[c.rank + '_' + c.suit] = true; });
    }
  });

  /* Cards that are part of a straight potential (3+ consecutive ranks) */
  var nRanks = Object.keys(byRank).map(Number).filter(function (r) { return r !== 12; }).sort(function (a,b) { return a-b; });
  for (var si = 0; si < nRanks.length - 2; si++) {
    if (nRanks[si+1] === nRanks[si]+1 && nRanks[si+2] === nRanks[si]+2) {
      [nRanks[si], nRanks[si+1], nRanks[si+2]].forEach(function (r) {
        byRank[r].forEach(function (c) { valuable[c.rank + '_' + c.suit] = true; });
      });
    }
  }

  return { valuable: valuable };
}

/*
  Score a combo: LOWER score = prefer to play NOW.
  Higher score = save these cards for later.
*/
function botComboScore(combo, hand, analysis) {
  var score = 0;

  combo.cards.forEach(function (c) {
    /* Give extra weight to 2s (rank 12) and Aces (rank 11) */
    var cv = c.rank <= 10 ? c.rank : (c.rank === 11 ? 20 : 35);
    score += cv;
  });

  /* Penalty for breaking a valuable cluster */
  var breaksValuable = combo.cards.some(function (c) {
    return analysis.valuable[c.rank + '_' + c.suit];
  });
  if (breaksValuable) score += 18;

  /* Big bonus for clearing the hand entirely */
  if (combo.cards.length === hand.length) score -= 500;
  /* Decent bonus for leaving just 1 card */
  if (combo.cards.length === hand.length - 1) score -= 60;

  /* Bonus for combos that use ONLY non-valuable cards (junk dump) */
  var allJunk = combo.cards.every(function (c) {
    return !analysis.valuable[c.rank + '_' + c.suit];
  });
  if (allJunk) score -= 10;

  return score;
}

/*
  Select the best combo from candidates based on:
  1. Type matching (prefer playing same type against table)
  2. Saving premium cards (A/2)
  3. Not wasting bombs on non-2 combos
  4. Dumping junk / low-value cards first when leading
*/
function botSelectCombo(hand, combos, against) {
  var analysis = analyzeHand(hand);

  function bestOf(pool) {
    pool.sort(function (a, b) { return botComboScore(a, hand, analysis) - botComboScore(b, hand, analysis); });
    return pool[0];
  }

  /* Always take a hand-clearing combo immediately */
  var clears = combos.filter(function (c) { return c.cards.length === hand.length; });
  if (clears.length) return clears[0];

  if (!against) {
    /* === LEADING === */
    /* Try to lead with isolated singles (cards with no combo potential) */
    var isolated = combos.filter(function (c) {
      return c.type === 'single' &&
        !analysis.valuable[c.cards[0].rank + '_' + c.cards[0].suit] &&
        c.cards[0].rank <= 10; /* not A or 2 */
    });
    if (isolated.length) return bestOf(isolated);

    /* Try low pairs (not involving A/2) */
    var lowPairs = combos.filter(function (c) {
      return c.type === 'pair' && c.rank <= 9;
    });
    if (lowPairs.length) return bestOf(lowPairs);

    /* Any safe single (not A/2) */
    var safeSingles = combos.filter(function (c) {
      return c.type === 'single' && c.rank <= 10;
    });
    if (safeSingles.length) return bestOf(safeSingles);

    /* Fallback */
    return bestOf(combos);

  } else {
    /* === FOLLOWING === */

    /* Against a 2 (single): must use bomb if available */
    if (against.type === 'single' && against.rank === 12) {
      var bombs = combos.filter(function (c) { return c.type === 'four' || c.type === 'conspair'; });
      if (bombs.length) {
        /* Use smallest bomb (conspair before four, fewer pairs first) */
        bombs.sort(function (a, b) {
          var aLen = a.type === 'conspair' ? a.len : 100;
          var bLen = b.type === 'conspair' ? b.len : 100;
          return aLen - bLen;
        });
        return bombs[0];
      }
    }

    /* Against a 2 pair: need 4+ conspair or four */
    if (against.type === 'pair' && against.rank === 12) {
      var bigBombs = combos.filter(function (c) {
        return c.type === 'four' || (c.type === 'conspair' && c.len >= 4);
      });
      if (bigBombs.length) return bestOf(bigBombs);
    }

    /* Same-type match: strongly prefer this */
    var sameType = combos.filter(function (c) { return c.type === against.type; });
    if (sameType.length) {
      /* Within same-type: avoid using premium (A/2) unless nothing else */
      var nonPremium = sameType.filter(function (c) {
        return c.cards.every(function (card) { return card.rank <= 10; });
      });
      return bestOf(nonPremium.length ? nonPremium : sameType);
    }

    /* No same-type: use any valid non-bomb if possible */
    var noBombs = combos.filter(function (c) { return c.type !== 'four' && c.type !== 'conspair'; });
    if (noBombs.length) return bestOf(noBombs);

    /* Last resort: use a bomb */
    return bestOf(combos);
  }
}

function tlBotTurn() {
  if (TL.finished.indexOf(TL.currentTurn) !== -1 || TL.gameOver) { tlNextTurn(); return; }
  var pid    = TL.currentTurn;
  var hand   = TL.hands[pid];
  var combos = validPlays(hand, TL.lastCombo);

  if (!combos.length) {
    /* Table empty but no plays? Forced single (shouldn't happen normally) */
    if (!TL.lastCombo) {
      var forced = detectCombo([hand[0]]);
      if (forced) { SFX.play('play'); tlDoPlay(pid, forced); return; }
    }
    SFX.play('pass');
    tlDoPass(pid);
    return;
  }

  var chosen = botSelectCombo(hand, combos, TL.lastCombo);
  SFX.play('play');
  tlDoPlay(pid, chosen);
}

/* ============================================================
   TI·∫æN L√äN ‚Äî RESULT
   ============================================================ */
function tlShowResult() {
  var order  = TL.finished.slice();
  var rkL    = [t('rkL1'), t('rkL2'), t('rkL3'), t('rkL4')];
  var rkC    = ['#f1c40f','#bdc3c7','#cd6133','#e74c3c'];
  var html   = '';
  order.forEach(function (pid, i) {
    var isYou = pid === 0;
    html += '<div style="margin:7px 0;font-size:' + (isYou ? '1.18rem' : '0.95rem') +
      ';font-weight:' + (isYou ? '800' : '400') +
      ';color:' + (isYou ? rkC[i] : 'inherit') + '">' +
      rkL[i] + ' &nbsp; ' + t('playerNames')[pid] +
      (isYou ? ' ' + t('youM') : '') + '</div>';
  });
  var pRank  = order.indexOf(0) + 1;
  var type   = pRank <= 3 ? 'win' : 'lose';
  var titles = { 1:t('rank1t'), 2:t('rank2t'), 3:t('rank3t'), 4:t('rank4t') };
  showResult(titles[pRank], html, type, tlInit);
}

/* ============================================================
   X√å D√ÅCH ‚Äî STATE
   ============================================================ */
var XD_RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

var XD = { deck:[], player:[], dealer:[], chips:1000, bet:0, phase:'betting', hideDealer:true };

/* Animation counters: how many cards from the END of each row should animate */
var _xdAnim = { d: 0, p: 0 };

function xdMakeDeck() {
  var d = [];
  for (var s = 0; s < 4; s++) for (var r = 0; r < 13; r++) d.push({ rank:r, suit:s });
  return shuffle(d);
}

function xdScore(cards) {
  var s = 0, aces = 0;
  cards.forEach(function (c) {
    if (c.rank === 0) { s += 11; aces++; }
    else if (c.rank >= 9) s += 10;
    else s += c.rank + 1;
  });
  while (s > 21 && aces > 0) { s -= 10; aces--; }
  return s;
}

function xdBJ(c) { return c.length===2 && c.some(function(x){return x.rank===0;}) && c.some(function(x){return x.rank>=9;}); }
function xdNL(c) { return c.length===5 && xdScore(c)<=21; }
function xdXB(c) { return c.length===2 && c[0].rank===0 && c[1].rank===0; }

/* ===== XD RENDER ===== */
function xdRender() {
  document.getElementById('xd-chips').textContent    = XD.chips;
  document.getElementById('xd-bet-disp').textContent = XD.bet;

  /* Dealer zone */
  var dRow = document.getElementById('xd-dealer-cards');
  dRow.innerHTML = '';
  var dLen = XD.dealer.length;
  XD.dealer.forEach(function (c, i) {
    var el = xdElCard(c, i === 0 && XD.hideDealer);
    if (_xdAnim.d > 0 && i >= dLen - _xdAnim.d) el.classList.add('card-anim-in');
    dRow.appendChild(el);
  });

  var dSc = document.getElementById('xd-dealer-score');
  if (!XD.dealer.length) { dSc.textContent = ''; }
  else if (XD.hideDealer) { dSc.textContent = '? + ' + xdScore(XD.dealer.slice(1)); }
  else {
    var ds = xdScore(XD.dealer);
    dSc.textContent = t('score') + ' ' + ds + (ds > 21 ? ' ' + t('bust') : '');
  }

  /* Player zone */
  var pRow = document.getElementById('xd-player-cards');
  pRow.innerHTML = '';
  var pLen = XD.player.length;
  XD.player.forEach(function (c, i) {
    var el = xdElCard(c, false);
    if (_xdAnim.p > 0 && i >= pLen - _xdAnim.p) el.classList.add('card-anim-in');
    pRow.appendChild(el);
  });

  var pSc = document.getElementById('xd-player-score');
  if (!XD.player.length) { pSc.textContent = ''; }
  else {
    var ps = xdScore(XD.player), extra = '';
    if      (xdBJ(XD.player)) extra = ' ' + t('bjLabel');
    else if (xdXB(XD.player)) extra = ' ' + t('xiBanLabel');
    else if (xdNL(XD.player)) extra = ' ' + t('ngLinh');
    else if (ps > 21)          extra = ' ' + t('bust');
    pSc.textContent = t('score') + ' ' + ps + extra;
  }

  /* Show/hide button rows */
  document.getElementById('xd-bet-row').style.display  = XD.phase === 'betting' ? 'flex' : 'none';
  document.getElementById('xd-game-row').style.display = XD.phase === 'playing' ? 'flex' : 'none';

  /* Stand button: disabled when player score < 16 (must keep hitting) */
  var standBtn = document.querySelector('#xd-game-row .btn.danger');
  if (standBtn) standBtn.disabled = XD.phase === 'playing' && xdScore(XD.player) < 16;

  /* Reset animation counters after rendering */
  _xdAnim = { d: 0, p: 0 };
}

function xdElCard(c, hidden) {
  var el = document.createElement('div');
  el.className = 'card' + (hidden ? ' back' : (c.suit >= 2 ? ' red' : ''));
  if (!hidden) {
    var rn = XD_RANKS[c.rank], ss = SUITS_SYM[c.suit];
    el.innerHTML =
      '<div class="card-top"><div class="card-rank">' + rn + '</div><div class="card-suit-sm">' + ss + '</div></div>' +
      '<div class="card-center">' + ss + '</div>' +
      '<div class="card-bot"><div class="card-rank">' + rn + '</div><div class="card-suit-sm">' + ss + '</div></div>';
  }
  return el;
}

/* ===== XD ACTIONS ===== */
function startXiDach() {
  showScreen('xidach');
  try { XD.chips = parseInt(localStorage.getItem('xd_chips'), 10) || 1000; } catch (e) { XD.chips = 1000; }
  if (XD.chips < 10) XD.chips = 1000;
  XD.bet = 0; XD.phase = 'betting';
  XD.player = []; XD.dealer = [];
  XD.deck = xdMakeDeck();
  _xdAnim = { d: 0, p: 0 };
  xdRender();
}

function xdBet(amt) {
  if (XD.phase !== 'betting') return;
  if (XD.bet + amt > XD.chips) { notify(t('noChips')); return; }
  SFX.play('click');
  XD.bet += amt; xdRender();
}

function xdClearBet() {
  if (XD.phase !== 'betting') return;
  SFX.play('click');
  XD.bet = 0; xdRender();
}

function xdDraw() {
  if (XD.deck.length < 4) XD.deck = xdMakeDeck();
  return XD.deck.pop();
}

function xdDeal() {
  if (!XD.bet) { notify(t('betFirst')); return; }
  SFX.play('deal');
  XD.player  = [xdDraw(), xdDraw()];
  XD.dealer  = [xdDraw(), xdDraw()];
  XD.hideDealer = true; XD.phase = 'playing';
  _xdAnim = { d: 2, p: 2 };
  xdRender();

  var pBJ = xdBJ(XD.player), dBJ = xdBJ(XD.dealer);
  if (pBJ || dBJ) {
    XD.hideDealer = false; _xdAnim = { d: 0, p: 0 }; xdRender();
    setTimeout(function () {
      if      (pBJ && dBJ) xdEnd('draw', t('xdBothBJ'));
      else if (pBJ)        xdEnd('win',  t('xdYouBJ'));
      else                 xdEnd('lose', t('xdDealerBJ'));
    }, 600);
    return;
  }
  if (xdXB(XD.player)) notify(t('xdXiBan'));
}

function xdHit() {
  if (XD.phase !== 'playing') return;
  SFX.play('play');
  _xdAnim = { d: 0, p: 1 };
  XD.player.push(xdDraw());
  xdRender();
  var s = xdScore(XD.player);
  if (s > 21) { setTimeout(function () { xdEnd('lose', t('xdBust')); }, 400); return; }
  if (xdNL(XD.player)) {
    XD.hideDealer = false; _xdAnim = { d: 0, p: 0 }; xdRender();
    setTimeout(function () { xdEnd('win', t('xdNguLinh')); }, 500);
  }
}

function xdStand() {
  if (XD.phase !== 'playing') return;
  SFX.play('click');
  XD.phase = 'dealer'; XD.hideDealer = false;
  _xdAnim = { d: 0, p: 0 }; xdRender();
  setTimeout(xdDealerDraw, 600);
}

function xdDealerDraw() {
  if (xdScore(XD.dealer) < 17) {
    SFX.play('play');
    _xdAnim = { d: 1, p: 0 };
    XD.dealer.push(xdDraw());
    xdRender();
    setTimeout(xdDealerDraw, 680);
    return;
  }
  var ps = xdScore(XD.player), ds = xdScore(XD.dealer);
  if      (ds > 21) xdEnd('win',  t('xdDlBust') + ' (' + ds + ')');
  else if (ps > ds) xdEnd('win',  ps + ' vs ' + ds + ' ‚Äî ' + t('xdWin'));
  else if (ds > ps) xdEnd('lose', ps + ' vs ' + ds + ' ‚Äî ' + t('xdLose'));
  else              xdEnd('draw', ps + ' vs ' + ds + ' ‚Äî ' + t('xdDraw'));
}

function xdEnd(outcome, msg) {
  XD.phase = 'done';
  var won = 0;
  if (outcome === 'win') {
    won = xdBJ(XD.player) ? Math.floor(XD.bet * 1.5) : XD.bet;
    XD.chips += won;
    if (xdBJ(XD.player)) SFX.play('bj'); else SFX.play('win');
  } else if (outcome === 'lose') {
    XD.chips -= XD.bet;
    SFX.play('lose');
  } else {
    SFX.play('click');
  }
  if (XD.chips < 10) { XD.chips = 500; notify(t('outOfChips')); }
  try { localStorage.setItem('xd_chips', XD.chips); } catch (e) {}
  _xdAnim = { d: 0, p: 0 }; xdRender();

  var chipMsg = outcome === 'win'
    ? '<br><span style="color:var(--win)">+' + won + ' chips</span>'
    : outcome === 'lose'
      ? '<br><span style="color:var(--lose)">-' + XD.bet + ' chips</span>'
      : '';
  showResult(msg, t('chipsLeft') + ' <strong>' + XD.chips + '</strong>' + chipMsg, outcome, function () {
    XD.bet = 0; XD.phase = 'betting';
    XD.player = []; XD.dealer = [];
    _xdAnim = { d: 0, p: 0 }; xdRender();
  });
}

/* ============================================================
   UTILS ‚Äî SCREEN / RESULT / NOTIFY / THEME
   ============================================================ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function (s) { s.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
  document.body.classList.toggle('in-game', id !== 'menu');
  if (id === 'menu') checkContinue();
}

function goMenu() {
  SFX.play('click');
  _wsOnline = false; _wsMyIndex = 0; _wsHumanSlots = [0];
  showScreen('menu');
}

function startTienLen() {
  SFX.play('click');
  showScreen('tienlen');
  tlInit();
}

var _resultCb = null;
function showResult(title, descHtml, type, onAgain) {
  document.querySelectorAll('.overlay').forEach(function (el) { el.remove(); });
  _resultCb = onAgain;
  var ov   = document.createElement('div');
  ov.className = 'overlay';
  var icon = type === 'win' ? 'üèÜ ' : type === 'lose' ? 'üòì ' : 'ü§ù ';
  ov.innerHTML =
    '<div class="result-box">' +
      '<div class="result-title ' + type + '">' + icon + title + '</div>' +
      '<div class="result-desc">' + descHtml + '</div>' +
      '<div class="result-btns">' +
        '<button class="btn accent" onclick="document.querySelector(\'.overlay\').remove();_resultCb&&_resultCb()">' + t('playAgain') + '</button>' +
        '<button class="btn" onclick="document.querySelector(\'.overlay\').remove();goMenu()">' + t('home') + '</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(ov);
}

function notify(msg) {
  document.querySelectorAll('.notif').forEach(function (n) { n.remove(); });
  var el = document.createElement('div');
  el.className = 'notif'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(function () { el.remove(); }, 2500);
}

/* ===== THEME ===== */
var _dark = true;
function toggleTheme() {
  SFX.play('click');
  _dark = !_dark;
  document.documentElement.dataset.theme = _dark ? 'dark' : 'light';
  updateThemeBtns();
}
function updateThemeBtns() {
  var lbl = _dark ? '‚òÄÔ∏è' : 'üåô';
  ['menu-theme-btn','tl-theme-btn','xd-theme-btn','ph-theme-btn'].forEach(function (id) {
    var el = document.getElementById(id); if (el) el.textContent = lbl;
  });
}

/* ============================================================
   LOBBY ‚Äî mode select (solo vs online) for TL and XD
   ============================================================ */
var _lobbyGame = ''; /* 'tl' | 'xd' */

function openLobby(game) {
  SFX.play('click');
  _lobbyGame = game;
  /* Reset room panel state */
  document.getElementById('room-panel').style.display       = 'none';
  document.getElementById('room-code-area').style.display   = 'none';
  document.getElementById('room-join-area').style.display   = 'none';

  var names = {
    tl: { title: LANG==='vi' ? 'Ti·∫øn L√™n Mi·ªÅn Nam' : 'Tien Len',
          sub:   LANG==='vi' ? 'Ch·ªçn ch·∫ø ƒë·ªô ch∆°i' : 'Select game mode',
          solo:  LANG==='vi' ? 'Ch∆°i v·ªõi Bot' : 'vs Bots',
          soloD: LANG==='vi' ? 'ƒê∆°n gi·∫£n, kh√¥ng c·∫ßn internet' : 'Offline, play against bots',
          onl:   LANG==='vi' ? 'Ch∆°i Online' : 'Play Online',
          onlD:  LANG==='vi' ? 'T·∫°o ph√≤ng, m·ªùi b·∫°n b√®' : 'Create a room, invite friends' },
    xd: { title: LANG==='vi' ? 'X√¨ D√°ch' : 'Blackjack',
          sub:   LANG==='vi' ? 'Ch·ªçn ch·∫ø ƒë·ªô ch∆°i' : 'Select game mode',
          solo:  LANG==='vi' ? 'Ch∆°i v·ªõi Bot' : 'vs Bot Dealer',
          soloD: LANG==='vi' ? 'ƒê∆°n gi·∫£n, kh√¥ng c·∫ßn internet' : 'Offline vs dealer bot',
          onl:   LANG==='vi' ? 'Ch∆°i Online' : 'Play Online',
          onlD:  LANG==='vi' ? 'Ch∆°i c√πng b·∫°n b√® (t·ªëi ƒëa 2 ng∆∞·ªùi)' : 'Play with a friend (max 2)' }
  };
  var n = names[game];
  document.getElementById('lobby-title').textContent        = n.title;
  document.getElementById('lobby-sub').textContent          = n.sub;
  document.getElementById('lobby-solo-title').textContent   = n.solo;
  document.getElementById('lobby-solo-desc').textContent    = n.soloD;
  document.getElementById('lobby-online-title').textContent = n.onl;
  document.getElementById('lobby-online-desc').textContent  = n.onlD;
  showScreen('lobby');
}

function lobbySolo() {
  SFX.play('click');
  if (_lobbyGame === 'tl') { showScreen('tienlen'); tlInit(); }
  else                      { startXiDach(); }
}

function lobbyShowOnline() {
  SFX.play('click');
  document.getElementById('room-panel').style.display = 'flex';
  document.getElementById('room-code-area').style.display  = 'none';
  document.getElementById('room-join-area').style.display  = 'none';
  document.getElementById('room-panel-title').textContent  =
    LANG === 'vi' ? 'Ch∆°i Online' : 'Play Online';
  document.getElementById('room-name-input').value = '';
}

function showJoinForm() {
  SFX.play('click');
  document.getElementById('room-join-area').style.display  = 'flex';
  document.getElementById('room-create-btn').style.display = 'none';
  document.getElementById('room-joinbtn').style.display    = 'none';
  document.getElementById('room-code-input').value         = '';
  document.getElementById('room-join-status').textContent  = '';
}

/* ============================================================
   WEBSOCKET CLIENT
   ============================================================ */
var WS = null;
var _wsRoom = '';
var _wsName = '';
var _wsRole = ''; /* 'host' | 'guest' */

/* Online game state */
var _wsOnline      = false;  /* true when playing online */
var _wsMyIndex     = 0;      /* which seat this client occupies (0-3 for TL, always 0 for XD) */
var _wsHumanSlots  = [0];    /* which seat indices are real humans (rest = bots) */

/* Server URL ‚Äî replace with your deployed server address */
var WS_URL = 'wss://card-games-production.up.railway.app ';

function wsConnect(onOpen) {
  if (WS && WS.readyState <= 1) { if (onOpen) onOpen(); return; }
  try {
    WS = new WebSocket(WS_URL);
    WS.onopen    = function () { if (onOpen) onOpen(); };
    WS.onmessage = function (ev) {
      try { wsHandle(JSON.parse(ev.data)); } catch (e) {}
    };
    WS.onerror   = function () { wsNotify(LANG==='vi' ? '‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server' : '‚ùå Cannot connect to server'); };
    WS.onclose   = function () {};
  } catch (e) {
    wsNotify(LANG==='vi' ? '‚ùå WebSocket kh√¥ng kh·∫£ d·ª•ng' : '‚ùå WebSocket not available');
  }
}

function wsSend(obj) {
  if (WS && WS.readyState === 1) WS.send(JSON.stringify(obj));
}

function wsCreate() {
  _wsName = (document.getElementById('room-name-input').value || '').trim();
  if (!_wsName) {
    wsNotify(LANG==='vi' ? 'Nh·∫≠p t√™n c·ªßa b·∫°n tr∆∞·ªõc!' : 'Enter your name first!'); return;
  }
  wsConnect(function () {
    _wsRole = 'host';
    wsSend({ type: 'create', game: _lobbyGame, name: _wsName });
  });
}

function wsJoin() {
  _wsName = (document.getElementById('room-name-input').value || '').trim();
  var code = (document.getElementById('room-code-input').value || '').trim().toUpperCase();
  if (!_wsName) { wsNotify(LANG==='vi' ? 'Nh·∫≠p t√™n c·ªßa b·∫°n tr∆∞·ªõc!' : 'Enter your name first!'); return; }
  if (code.length !== 4) { wsNotify(LANG==='vi' ? 'M√£ ph√≤ng ph·∫£i 4 k√Ω t·ª±' : 'Room code must be 4 chars'); return; }
  wsConnect(function () {
    _wsRole = 'guest';
    _wsRoom = code;
    wsSend({ type: 'join', game: _lobbyGame, name: _wsName, code: code });
  });
}

function wsStartGame() {
  wsSend({ type: 'start', code: _wsRoom });
}

function wsLeave() {
  wsSend({ type: 'leave', code: _wsRoom });
  if (WS) { WS.close(); WS = null; }
  document.getElementById('room-panel').style.display     = 'none';
  document.getElementById('room-code-area').style.display = 'none';
  document.getElementById('room-join-area').style.display = 'none';
}

function wsHandle(msg) {
  switch (msg.type) {
    case 'created':
      _wsRoom = msg.code;
      document.getElementById('room-code-area').style.display  = 'flex';
      document.getElementById('room-join-area').style.display  = 'none';
      document.getElementById('room-create-btn').style.display = 'none';
      document.getElementById('room-joinbtn').style.display    = 'none';
      document.getElementById('room-code-disp').textContent    = msg.code;
      document.getElementById('room-players-info').textContent =
        '1/' + (msg.maxPlayers||4) + ' ' + (LANG==='vi' ? 'ng∆∞·ªùi' : 'players');
      break;

    case 'joined':
      document.getElementById('room-join-status').textContent =
        LANG==='vi' ? '‚úÖ ƒê√£ v√†o ph√≤ng ' + msg.code : '‚úÖ Joined room ' + msg.code;
      document.getElementById('room-code-area').style.display = 'flex';
      document.getElementById('room-code-disp').textContent   = msg.code;
      break;

    case 'players':
      var info = msg.players.join(', ') + ' (' + msg.count + '/' + msg.max + ')';
      ['room-players-info','room-join-status'].forEach(function (id) {
        var el = document.getElementById(id); if (el) el.textContent = info;
      });
      var startBtn = document.getElementById('room-start-btn');
      if (startBtn) startBtn.disabled = (msg.count < 2);
      break;

    case 'start_tl':
      /* Server sends shuffled hands and turn order */
      wsStartTL(msg);
      break;

    case 'start_xd':
      wsStartXD(msg);
      break;

    case 'move':
      wsApplyMove(msg);
      break;

    case 'error':
      wsNotify('‚ö†Ô∏è ' + (msg.message || 'Error'));
      break;
  }
}

/* Online TL ‚Äî set up game from server data */
function wsStartTL(msg) {
  /* msg.hands: array of 4 hand arrays [{r,s},...] */
  /* msg.yourIndex: which seat this client is */
  /* msg.humanSlots: which seats are real humans */
  _wsOnline     = true;
  _wsMyIndex    = msg.yourIndex || 0;
  _wsHumanSlots = msg.humanSlots || [0];

  TL.hands = msg.hands.map(function (h) {
    return h.map(function (c) { return new TCard(c.r, c.s); });
  });
  TL.currentTurn = msg.currentTurn || 0;
  TL.lastCombo = null; TL.lastBy = -1;
  TL.passCount = 0;   TL.finished = []; TL.selected = [];
  TL.gameOver  = false;
  clearVPCache();
  showScreen('tienlen');
  notify(LANG === 'vi' ? 'üåê Ch∆°i Online ‚Äî V·ªã tr√≠ ' + (msg.yourIndex+1) : 'üåê Online ‚Äî Seat ' + (msg.yourIndex+1));
  tlRender();
  /* If first turn is a bot slot, start bot */
  if (isBotTurn()) setTimeout(tlBotTurn, 1000);
}

function wsStartXD(msg) {
  /* Online XD: each player plays vs a bot dealer with server-dealt cards */
  _wsOnline  = true;
  _wsMyIndex = 0; /* in XD, always seat 0 = player */
  showScreen('xidach');
  /* Keep existing chips, just start a round */
  XD.bet  = XD.pendingBet || XD.bet || 50; /* use whatever bet was set */
  XD.phase = 'playing';
  XD.player = msg.player.map(function (c) { return { rank: c.r, suit: c.s }; });
  XD.dealer = msg.dealer.map(function (c) { return { rank: c.r, suit: c.s }; });
  XD.hideDealer = true;
  _xdAnim = { d: 2, p: 2 };
  SFX.play('deal');
  xdRender();
  notify(LANG === 'vi' ? 'üåê Ch∆°i Online ‚Äî B√†i ƒë√£ ƒë∆∞·ª£c chia!' : 'üåê Online ‚Äî Cards dealt!');
}

function wsApplyMove(msg) {
  /* Relay opponent moves to the local game engine */
  if (_lobbyGame === 'tl') {
    TL.currentTurn = msg.pid;
    if (msg.action === 'play') {
      var combo = {
        type: msg.combo.type, rank: msg.combo.rank,
        suit: msg.combo.suit, ts: msg.combo.ts,
        len: msg.combo.len,   topRank: msg.combo.topRank,
        cards: msg.combo.cards.map(function (c) { return new TCard(c.r, c.s); })
      };
      /* Remove played cards from the remote player's hand by rank+suit match */
      combo.cards.forEach(function (pc) {
        var hand = TL.hands[msg.pid];
        for (var i = 0; i < hand.length; i++) {
          if (hand[i].rank === pc.rank && hand[i].suit === pc.suit) {
            hand.splice(i, 1); break;
          }
        }
      });
      tlDoPlay(msg.pid, combo);
    } else if (msg.action === 'pass') {
      tlDoPass(msg.pid);
    }
  }
}

function wsNotify(msg) { notify(msg); }

/* ============================================================
   PH·ªéM / T√Å L·∫¢ ENGINE
   ============================================================

   Lu·∫≠t chu·∫©n:
   - 4 ng∆∞·ªùi ch∆°i, b·ªô 52 l√°, kh√¥ng t√≠nh J
     (b·ªô Ph·ªèm d√πng 52 l√° c√≥ A-2-3-...-10-J-Q-K)
   - Chia 9 l√°/ng∆∞·ªùi, ng∆∞·ªùi ƒë·∫ßu 10 l√° (ƒë√°nh ngay 1 l√°)
   - L∆∞·ª£t: ƒÉn b√†i v·ª´a ƒë√°nh (n·∫øu t·∫°o th√†nh Ph·ªèm) HO·∫∂C b·ªëc n·ªçc
   - ƒê√°nh 1 l√° ra
   - Ph·ªèm: b·ªô 3-4 l√° c√πng s·ªë HO·∫∂C 3+ l√° li√™n ti·∫øp c√πng ch·∫•t
   - √ô: h·∫øt r√°c ‚Üí th·∫Øng ngay
   - Sau 4 v√≤ng (ho·∫∑c ai √ô): ƒë·∫øm ƒëi·ªÉm r√°c, √≠t nh·∫•t th·∫Øng
   ============================================================ */

/* Ph·ªèm d√πng b·ªô 52 l√° nh∆∞ng th·ª© t·ª± rank kh√°c TL:
   A=1, 2..10, J=11, Q=12, K=13 */
var PH_RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
/* Suits: same as TL */

function PCard(rank, suit) { /* rank: 0=A,1=2,...,12=K */
  this.rank = rank; this.suit = suit;
}
Object.defineProperties(PCard.prototype, {
  rn:  { get: function () { return PH_RANKS[this.rank]; } },
  ss:  { get: function () { return SUITS_SYM[this.suit]; } },
  red: { get: function () { return IS_RED[this.suit]; } },
  pts: { get: function () {
    /* A=1, 2-9=face, 10/J/Q/K=10 */
    if (this.rank === 0) return 1;
    if (this.rank <= 8) return this.rank + 1; /* 2=2,...,9=9 */
    return 10; /* 10,J,Q,K */
  }}
});

function phMakeDeck() {
  var d = [];
  for (var s = 0; s < 4; s++) {
    for (var r = 0; r < 13; r++) {
      d.push(new PCard(r, s));
    }
  }
  return shuffle(d);
}

/* ---- Ph·ªèm detection ---- */
function phIsGroup(cards) {
  /* 3-4 l√° c√πng s·ªë */
  if (cards.length < 3 || cards.length > 4) return false;
  var r = cards[0].rank;
  for (var i = 1; i < cards.length; i++) if (cards[i].rank !== r) return false;
  return true;
}

function phIsSeq(cards) {
  /* 3+ l√° li√™n ti·∫øp c√πng ch·∫•t */
  if (cards.length < 3) return false;
  var sorted = cards.slice().sort(function (a, b) { return a.rank - b.rank; });
  var s = sorted[0].suit;
  for (var i = 0; i < sorted.length; i++) {
    if (sorted[i].suit !== s) return false;
    if (i > 0 && sorted[i].rank !== sorted[i-1].rank + 1) return false;
  }
  return true;
}

function phIsPhom(cards) {
  return phIsGroup(cards) || phIsSeq(cards);
}

/*
  Best grouping: given a hand, find partition that minimises deadwood.
  We use a greedy approach with backtracking limited to 3-card + 4-card sets.
  Returns { phoms: [[cards], ...], deadwood: [cards] }
*/
function phBestGrouping(hand) {
  var best = {
    phoms: [], deadwood: hand.slice(),
    pts: hand.reduce(function (s, c) { return s + c.pts; }, 0)
  };

  function search(remaining, phoms) {
    var n = remaining.length;
    if (n < 3) {
      var pts = remaining.reduce(function (s, c) { return s + c.pts; }, 0);
      if (pts < best.pts) {
        best = { phoms: phoms.slice(), deadwood: remaining.slice(), pts: pts };
      }
      return;
    }

    var tried = false;

    /* Try combos of size 4 then 3 */
    [4, 3].forEach(function (si) {
      if (si > n) return;
      var idxs = [];
      function pickSize(start, depth) {
        if (depth === si) {
          var combo = idxs.map(function (i) { return remaining[i]; });
          if (phIsPhom(combo)) {
            tried = true;
            var rest = remaining.filter(function (_, i) { return idxs.indexOf(i) === -1; });
            phoms.push(combo);
            search(rest, phoms);
            phoms.pop();
          }
          return;
        }
        for (var ix = start; ix <= n - (si - depth); ix++) {
          idxs.push(ix);
          pickSize(ix + 1, depth + 1);
          idxs.pop();
        }
      }
      pickSize(0, 0);
    });

    if (!tried) {
      var pts2 = remaining.reduce(function (s, c) { return s + c.pts; }, 0);
      if (pts2 < best.pts) {
        best = { phoms: phoms.slice(), deadwood: remaining.slice(), pts: pts2 };
      }
    }
  }

  search(hand, []);
  return best;
}

/*
  Can a player "eat" (ƒÉn) the discard card?
  Returns the phom that would be formed (including discardCard), or null.
*/
function phCanEat(hand, discardCard) {
  /* Returns a phom combo (array of cards) that includes discardCard, or null */
  var n = hand.length;

  function trySize(si) {
    /* Find si cards in hand that, together with discardCard, form a phom */
    var idxs = [];
    function pick(start, depth) {
      if (depth === si) {
        var combo = idxs.map(function (i) { return hand[i]; }).concat([discardCard]);
        return phIsPhom(combo) ? combo : null;
      }
      for (var ix = start; ix < n; ix++) {
        idxs.push(ix);
        var res = pick(ix + 1, depth + 1);
        if (res) return res;
        idxs.pop();
      }
      return null;
    }
    return pick(0, 0);
  }

  return trySize(2) || trySize(3) || null;
}

/* ---- State ---- */
var PH = {
  hands:      [[], [], [], []],   /* PCard arrays */
  discard:    null,               /* top of discard pile */
  discardPile:[],
  deck:       [],
  currentTurn:0,
  phase:      'discard',          /* 'take' | 'discard' */
  round:      1,
  maxRounds:  4,
  selected:   null,               /* index in player hand, or null */
  gameOver:   false,
  uuBy:       -1                  /* who went Uu (phom out) */
};

/* ---- Init ---- */
function startPhom() {
  SFX.play('click');
  showScreen('phom');
  phInit();
}

function phInit() {
  PH.round = 1;
  PH.gameOver = false;
  PH.uuBy    = -1;
  phRedeal();
}

/* Redeal without touching round counter or gameOver */
function phRedeal() {
  var deck = phMakeDeck();
  PH.hands = [[], [], [], []];
  PH.discardPile = [];
  PH.discard     = null;
  PH.selected    = null;

  /* Deal: player 0 gets 10, others 9 */
  for (var i = 0; i < 4; i++) {
    var count = (i === 0) ? 10 : 9;
    for (var j = 0; j < count; j++) PH.hands[i].push(deck.pop());
  }
  PH.deck = deck;

  /* Sort hands */
  PH.hands.forEach(function (h) {
    h.sort(function (a, b) { return a.rank !== b.rank ? a.rank - b.rank : a.suit - b.suit; });
  });

  /* Player 0 always starts each round and must discard first (has 10 l√°) */
  PH.currentTurn = 0;
  PH.phase = 'discard';
  SFX.play('deal');
  phRender();
}

/* ---- Render ---- */
function phRender() {
  phRenderBots();
  phRenderCenter();
  phRenderHand();
  phUpdateButtons();
}

function phRenderBots() {
  var row = document.getElementById('ph-bots-row');
  row.innerHTML = '';
  for (var i = 1; i <= 3; i++) {
    var isActive = PH.currentTurn === i && !PH.gameOver;
    var slot = document.createElement('div');
    slot.className = 'bot-slot' + (isActive ? ' active-turn' : '');
    var nameEl = document.createElement('div');
    nameEl.className = 'bot-name';
    var g = phBestGrouping(PH.hands[i]);
    var botLabel = t('phBotNames')[i-1] + ' ¬∑ ' + PH.hands[i].length + ' ' + (LANG==='vi' ? 'l√°' : 'cards');
    if (isActive) botLabel += ' ‚è≥';
    nameEl.textContent = botLabel;
    slot.appendChild(nameEl);
    var wrap = document.createElement('div');
    wrap.className = 'bot-cards-wrap';
    PH.hands[i].forEach(function (card) {
      wrap.appendChild(elCard(card, { back: true, sm: true }));
    });
    slot.appendChild(wrap);
    /* Show deadwood pts hint */
    var hint = document.createElement('div');
    hint.style.cssText = 'font-size:0.65rem;color:var(--text-dim);text-align:center;margin-top:3px';
    hint.textContent = (LANG==='vi' ? 'R√°c: ' : 'DW: ') + g.pts;
    slot.appendChild(hint);
    row.appendChild(slot);
  }
}

function phRenderCenter() {
  /* Turn label */
  var lbl = document.getElementById('ph-turn-label');
  if (PH.gameOver) {
    lbl.textContent = t('phGameEnd');
  } else if (PH.currentTurn === 0) {
    lbl.textContent = PH.phase === 'discard' ? t('phDisPhase') : t('phTakePhase');
  } else {
    lbl.textContent = t('phBotTurn') + ' ' + t('phBotNames')[PH.currentTurn - 1] + '...';
  }

  /* Discard slot */
  var ds = document.getElementById('ph-discard-slot');
  ds.innerHTML = '';
  if (PH.discard) {
    var cardEl = elCard(PH.discard, { anim: false });
    ds.appendChild(cardEl);
  }

  /* Noc count */
  document.getElementById('ph-noc-count').textContent = PH.deck.length + (LANG==='vi' ? ' l√°' : ' left');

  /* Round info */
  document.getElementById('ph-round-info').textContent =
    t('phRounds') + ' ' + PH.round + t('phOf') + PH.maxRounds;
}

function phRenderHand() {
  var handEl = document.getElementById('ph-hand');
  handEl.innerHTML = '';
  var myTurn = PH.currentTurn === 0 && !PH.gameOver;
  var g = phBestGrouping(PH.hands[0]);
  var inPhom = [];
  g.phoms.forEach(function (phom) { phom.forEach(function (c) { inPhom.push(c); }); });

  PH.hands[0].forEach(function (card, idx) {
    var isSel = PH.selected === idx;
    var isInPhom = inPhom.indexOf(card) !== -1;
    var el = elCard(card, { selected: isSel });
    /* Highlight phom cards with subtle border */
    if (isInPhom && !isSel) {
      el.style.borderColor = 'var(--highlight)';
      el.style.boxShadow   = '2px 3px 8px var(--card-shadow), 0 0 0 1.5px var(--highlight)';
    }
    if (myTurn) {
      (function (cardIdx) {
        el.addEventListener('click', function () { phSelectCard(cardIdx); });
      })(idx);
    }
    handEl.appendChild(el);
  });

  document.getElementById('ph-card-count').textContent = PH.hands[0].length;
  /* Show deadwood pts */
  document.getElementById('ph-player-info').textContent =
    (LANG==='vi' ? 'R√°c: ' : 'DW: ') + g.pts + (LANG==='vi' ? ' ƒëi·ªÉm' : ' pts');
}

function phUpdateButtons() {
  var myTurn  = PH.currentTurn === 0 && !PH.gameOver;
  var eatBtn  = document.getElementById('ph-eat-btn');
  var discBtn = document.getElementById('ph-discard-btn');
  var drawBtn = document.getElementById('ph-draw-btn');

  var canEat = myTurn && PH.phase === 'take' && PH.discard &&
    !!phCanEat(PH.hands[0], PH.discard);

  eatBtn.disabled  = !canEat;
  discBtn.disabled = !myTurn || PH.phase !== 'discard' || PH.selected === null;
  drawBtn.disabled = !myTurn || PH.phase !== 'take';
}

/* ---- Player actions ---- */
function phSelectCard(idx) {
  SFX.play('select');
  PH.selected = (PH.selected === idx) ? null : idx;
  phRenderHand();
  phUpdateButtons();
}

function phDraw() {
  /* Player draws from deck */
  if (PH.currentTurn !== 0 || PH.phase !== 'take') return;
  if (PH.deck.length === 0) { phEndRound(); return; }
  SFX.play('play');
  var card = PH.deck.pop();
  PH.hands[0].push(card);
  PH.hands[0].sort(function (a, b) { return a.rank !== b.rank ? a.rank - b.rank : a.suit - b.suit; });
  PH.selected = null;
  PH.phase = 'discard';
  phRender();
}

function phEat() {
  /* Player eats the discard */
  if (PH.currentTurn !== 0 || PH.phase !== 'take' || !PH.discard) return;
  var formed = phCanEat(PH.hands[0], PH.discard);
  if (!formed) { notify(LANG==='vi' ? 'Kh√¥ng ƒÉn ƒë∆∞·ª£c l√° n√†y!' : 'Cannot take this card!'); return; }
  SFX.play('play');
  /* Move discard card to hand; discard slot is now empty until player discards */
  PH.discardPile.push(PH.discard);
  PH.hands[0].push(PH.discard);
  PH.discard = null;
  PH.hands[0].sort(function (a, b) { return a.rank !== b.rank ? a.rank - b.rank : a.suit - b.suit; });
  PH.selected = null;
  PH.phase = 'discard';
  phRender();
}

function phDoDiscard() {
  if (PH.currentTurn !== 0 || PH.phase !== 'discard') return;
  if (PH.selected === null) { notify(LANG==='vi' ? 'Ch·ªçn b√†i ƒë·ªÉ ƒë√°nh ra!' : 'Select a card to discard!'); return; }
  SFX.play('play');
  var card = PH.hands[0].splice(PH.selected, 1)[0];
  PH.selected = null;
  phPlayerDiscard(0, card);
}

function phPlayerDiscard(pid, card) {
  /* Push old discard to pile */
  if (PH.discard) PH.discardPile.push(PH.discard);
  PH.discard = card;

  /* Check Uu: after discarding, remaining hand has 0 deadwood AND at least 3 cards in phoms */
  var remaining = PH.hands[pid];
  var g = remaining.length >= 3 ? phBestGrouping(remaining) : { pts: 999, phoms: [] };
  if (g.pts === 0 && g.phoms.length > 0) {
    PH.uuBy = pid;
    PH.gameOver = true;
    if (pid === 0) SFX.play('win'); else SFX.play('lose');
    phRender();
    if (pid === 0) notify(t('phUu'));
    else notify(t('phBotNames')[pid-1] + t('phUuOther'));
    setTimeout(phShowResult, 900);
    return;
  }

  /* Check round end (deck empty) */
  if (PH.deck.length === 0) { phEndRound(); return; }

  /* Advance turn */
  PH.currentTurn = (PH.currentTurn + 1) % 4;
  PH.phase = 'take';
  phRender();
  if (PH.currentTurn !== 0) setTimeout(phBotTurn, 800);
}

/* ---- Bot AI ---- */
function phBotTurn() {
  if (PH.gameOver || PH.currentTurn === 0) return;
  var pid  = PH.currentTurn;
  var hand = PH.hands[pid];

  /* Phase 1: take */
  if (PH.phase === 'take') {
    /* Try to eat discard if it improves grouping */
    var eatResult = PH.discard ? phCanEat(hand, PH.discard) : null;
    if (eatResult) {
      /* Eat: discard card goes to hand, slot becomes empty */
      PH.discardPile.push(PH.discard);
      hand.push(PH.discard);
      PH.discard = null;
      hand.sort(function (a, b) { return a.rank !== b.rank ? a.rank - b.rank : a.suit - b.suit; });
    } else {
      /* Draw from deck */
      if (PH.deck.length === 0) { phEndRound(); return; }
      hand.push(PH.deck.pop());
      hand.sort(function (a, b) { return a.rank !== b.rank ? a.rank - b.rank : a.suit - b.suit; });
    }
    PH.phase = 'discard';
    phRender();
    setTimeout(phBotTurn, 600);
    return;
  }

  /* Phase 2: discard */
  var g = phBestGrouping(hand);

  if (g.deadwood.length === 0) {
    /* √ô! ‚Äî bot has zero deadwood after having drawn/eaten.
       Must still discard one card. Pick the "least valuable" phom card
       (one that keeps the most phoms intact after removal). */
    var bestDiscard = hand[hand.length - 1];
    var bestPts = -1;
    hand.forEach(function (c) {
      var trial = hand.filter(function (x) { return x !== c; });
      var trialG = phBestGrouping(trial);
      /* After discarding c, check if still Uu */
      if (trialG.pts === 0 && trialG.deadwood.length === 0) {
        /* Still Uu after removing c ‚Üí c is safe to discard */
        if (c.pts > bestPts) { bestPts = c.pts; bestDiscard = c; }
      }
    });
    var idx = hand.indexOf(bestDiscard);
    if (idx !== -1) hand.splice(idx, 1);
    SFX.play('play');
    phPlayerDiscard(pid, bestDiscard);
    return;
  }

  /* Normal: discard highest-point deadwood card */
  var dw = g.deadwood.slice().sort(function (a, b) { return b.pts - a.pts; });
  var toDiscard = dw[0];
  var idx = hand.indexOf(toDiscard);
  if (idx !== -1) hand.splice(idx, 1);
  SFX.play('play');
  phPlayerDiscard(pid, toDiscard);
}

/* ---- Round / Game End ---- */
function phEndRound() {
  /* Called when deck runs out mid-turn ‚Äî round is over */
  if (PH.round >= PH.maxRounds) {
    /* All rounds done ‚Üí final result */
    PH.gameOver = true;
    phRender();
    var g0 = phBestGrouping(PH.hands[0]);
    SFX.play(g0.pts === 0 ? 'win' : 'lose');
    setTimeout(phShowResult, 600);
  } else {
    /* Start next round */
    PH.round++;
    notify((LANG === 'vi' ? 'V√≤ng ' : 'Round ') + PH.round + '!');
    setTimeout(phRedeal, 700);
  }
}

function phShowResult() {
  /* Compute deadwood for all players */
  var scores = PH.hands.map(function (h) { return phBestGrouping(h).pts; });
  var minPts = Math.min.apply(null, scores);
  var playerWon = (scores[0] === minPts);

  var html = '';
  var names = [LANG==='vi' ? 'B·∫°n' : 'You',
    t('phBotNames')[0], t('phBotNames')[1], t('phBotNames')[2]];
  var sorted = [0,1,2,3].sort(function (a, b) { return scores[a] - scores[b]; });
  var medals = ['ü•á','ü•à','ü•â','üíÄ'];
  sorted.forEach(function (pid, i) {
    var isYou = pid === 0;
    html += '<div style="margin:5px 0;font-size:' + (isYou ? '1.1rem' : '0.9rem') +
      ';font-weight:' + (isYou ? '700' : '400') + '">' +
      medals[i] + ' ' + names[pid] + ' ‚Äî ' + scores[pid] +
      (LANG==='vi' ? ' ƒëi·ªÉm r√°c' : ' deadwood pts') +
      (isYou ? ' ‚Üê' : '') + '</div>';
  });

  if (PH.uuBy === 0) {
    showResult(t('phUu'), html, 'win', startPhom);
  } else if (PH.uuBy > 0) {
    showResult(t('phBotNames')[PH.uuBy-1] + (LANG==='vi' ? ' √ô!' : ' wins!'), html, 'lose', startPhom);
  } else if (playerWon) {
    showResult(t('phWin'), html, 'win', startPhom);
  } else {
    showResult(t('phLose'), html, 'lose', startPhom);
  }
}

/* ---- Card renderer for PCard (same shape as TCard) ---- */
/* Reuse elCard ‚Äî PCard has same .rn, .ss, .red interface */

/* ============================================================
   TUTORIAL
   ============================================================ */
var TUT = {
  tl: {
    vi: {
      title: 'üìñ C√°ch ch∆°i Ti·∫øn L√™n',
      sections: [
        { h: 'M·ª•c ti√™u', p: 'ƒê√°nh h·∫øt b√†i tr√™n tay tr∆∞·ªõc c√°c ng∆∞·ªùi ch∆°i kh√°c. Ng∆∞·ªùi h·∫øt b√†i ƒë·∫ßu ti√™n th·∫Øng ü•á.' },
        { h: 'Th·ª© t·ª± b√†i (th·∫•p ‚Üí cao)', p: '3 ¬∑ 4 ¬∑ 5 ¬∑ 6 ¬∑ 7 ¬∑ 8 ¬∑ 9 ¬∑ 10 ¬∑ J ¬∑ Q ¬∑ K ¬∑ A ¬∑ 2\nCh·∫•t: ‚ô† &lt; ‚ô£ &lt; ‚ô¶ &lt; ‚ô•' },
        { h: 'C√°c ki·ªÉu ƒë√°nh', items: [
          'üÉè R√°c ‚Äî 1 l√° b·∫•t k·ª≥',
          'üë• ƒê√¥i ‚Äî 2 l√° c√πng s·ªë',
          'üë®‚Äçüë©‚Äçüë¶ S√°m ‚Äî 3 l√° c√πng s·ªë',
          'üí£ T·ª© qu√Ω ‚Äî 4 l√° c√πng s·ªë (ƒë√°nh ƒë∆∞·ª£c con 2)',
          'üî¢ S·∫£nh ‚Äî 3+ l√° li√™n ti·∫øp (kh√¥ng c√≥ 2)',
          'üîó ƒê√¥i th√¥ng ‚Äî 3+ ƒë√¥i li√™n ti·∫øp (ƒë√°nh ƒë∆∞·ª£c con 2)'
        ]},
        { h: 'Lu·∫≠t ƒë·∫∑c bi·ªát', items: [
          'ƒê·∫ßu v√°n: ng∆∞·ªùi c√≥ 3‚ô† ph·∫£i ƒë√°nh tr∆∞·ªõc v√† b·∫Øt bu·ªôc bao g·ªìm 3‚ô†',
          'Con 2 l√† b√†i m·∫°nh nh·∫•t; ch·ªâ b·ªã ƒë√°nh b·ªüi t·ª© qu√Ω ho·∫∑c ƒë√¥i th√¥ng',
          'Khi t·∫•t c·∫£ ng∆∞·ªùi ch∆°i c√≤n l·∫°i pass ‚Üí l∆∞·ª£t m·ªõi, ng∆∞·ªùi v·ª´a th·∫Øng d·∫´n'
        ]}
      ]
    },
    en: {
      title: 'üìñ How to Play Tien Len',
      sections: [
        { h: 'Goal', p: 'Be the first to play all cards from your hand. First to empty wins ü•á.' },
        { h: 'Card order (low ‚Üí high)', p: '3 ¬∑ 4 ¬∑ 5 ¬∑ 6 ¬∑ 7 ¬∑ 8 ¬∑ 9 ¬∑ 10 ¬∑ J ¬∑ Q ¬∑ K ¬∑ A ¬∑ 2\nSuit: ‚ô† &lt; ‚ô£ &lt; ‚ô¶ &lt; ‚ô•' },
        { h: 'Valid combinations', items: [
          'üÉè Single ‚Äî any 1 card',
          'üë• Pair ‚Äî 2 cards of the same rank',
          'üë®‚Äçüë©‚Äçüë¶ Triple ‚Äî 3 cards of the same rank',
          'üí£ Four of a Kind ‚Äî beats any single 2 or 3-pair sequence',
          'üî¢ Straight ‚Äî 3+ consecutive ranks (no 2s)',
          'üîó Consecutive Pairs ‚Äî 3+ consecutive pairs (beats a single 2)'
        ]},
        { h: 'Special rules', items: [
          'First turn: holder of 3‚ô† must lead and must include 3‚ô†',
          '2 is the strongest card; only beaten by four-of-a-kind or long cons. pairs',
          'When all remaining players pass ‚Üí new round, last winner leads'
        ]}
      ]
    }
  },
  xd: {
    vi: {
      title: 'üìñ C√°ch ch∆°i X√¨ D√°ch',
      sections: [
        { h: 'M·ª•c ti√™u', p: 'ƒê·∫°t ƒëi·ªÉm cao h∆°n Dealer nh∆∞ng kh√¥ng v∆∞·ª£t qu√° 21. V∆∞·ª£t 21 l√† Qu·∫Øc ‚Äî thua ngay.' },
        { h: 'T√≠nh ƒëi·ªÉm', items: [
          'A = 11 ƒëi·ªÉm (ho·∫∑c 1 n·∫øu b·ªã qu·∫Øc)',
          '10 / J / Q / K = 10 ƒëi·ªÉm',
          '2‚Äì9 = ƒë√∫ng m·∫∑t s·ªë'
        ]},
        { h: 'C√°c n∆∞·ªõc ƒëi', items: [
          'üÉè Chia b√†i ‚Äî ƒë·∫∑t c∆∞·ª£c r·ªìi b·∫Øt ƒë·∫ßu v√°n',
          '‚ûï R√∫t th√™m ‚Äî r√∫t th√™m 1 l√° (ph·∫£i r√∫t khi &lt; 16 ƒëi·ªÉm)',
          '‚úã D·ª´ng ‚Äî gi·ªØ ƒëi·ªÉm hi·ªán t·∫°i, Dealer r√∫t b√†i'
        ]},
        { h: 'Tay ƒë·∫∑c bi·ªát', items: [
          'üåü X√¨ D√°ch ‚Äî A + 10/J/Q/K ngay t·ª´ ƒë·∫ßu ‚Üí th·∫Øng 1.5√ó c∆∞·ª£c',
          'üÉè X√¨ B√†n ‚Äî 2 con A ‚Üí th·∫Øng ngay',
          'üéâ Ng≈© Linh ‚Äî 5 l√° kh√¥ng qu·∫Øc ‚Üí th·∫Øng ngay'
        ]},
        { h: 'Dealer', p: 'Dealer t·ª± ƒë·ªông r√∫t b√†i cho ƒë·∫øn khi ƒë·ªß 17 ƒëi·ªÉm. Dealer qu·∫Øc ‚Üí b·∫°n th·∫Øng.' }
      ]
    },
    en: {
      title: 'üìñ How to Play Blackjack',
      sections: [
        { h: 'Goal', p: 'Score higher than the Dealer without exceeding 21. Going over 21 is a Bust ‚Äî instant loss.' },
        { h: 'Card values', items: [
          'A = 11 (or 1 to avoid busting)',
          '10 / J / Q / K = 10 points',
          '2‚Äì9 = face value'
        ]},
        { h: 'Actions', items: [
          'üÉè Deal ‚Äî place a bet, then start the round',
          '‚ûï Hit ‚Äî draw one more card (must hit when under 16)',
          '‚úã Stand ‚Äî keep current score, Dealer draws'
        ]},
        { h: 'Special hands', items: [
          'üåü Blackjack ‚Äî A + 10/J/Q/K on first deal ‚Üí win 1.5√ó bet',
          'üÉè Double Ace ‚Äî 2 Aces dealt ‚Üí instant win',
          'üéâ Five Card Charlie ‚Äî 5 cards without busting ‚Üí instant win'
        ]},
        { h: 'Dealer rule', p: 'Dealer always draws until reaching 17+. Dealer busts ‚Üí you win.' }
      ]
    }
  }
};

function showTutorial(game) {
  SFX.play('click');
  /* Remove any existing tutorial */
  document.querySelectorAll('.tut-overlay').forEach(function (el) { el.remove(); });

  var data = TUT[game][LANG] || TUT[game]['vi'];

  /* Build sections HTML */
  var sectionsHtml = '';
  data.sections.forEach(function (sec) {
    sectionsHtml += '<div class="tut-section"><h3>' + sec.h + '</h3>';
    if (sec.p) {
      /* Replace literal \n with <br> */
      sectionsHtml += '<p>' + sec.p.replace(/\n/g, '<br>') + '</p>';
    }
    if (sec.items) {
      sectionsHtml += '<ul>';
      sec.items.forEach(function (it) { sectionsHtml += '<li>' + it + '</li>'; });
      sectionsHtml += '</ul>';
    }
    sectionsHtml += '</div>';
  });

  var closeLabel = LANG === 'vi' ? 'ƒê√£ hi·ªÉu, ch∆°i th√¥i! üéÆ' : 'Got it, let\'s play! üéÆ';

  var ov = document.createElement('div');
  ov.className = 'tut-overlay';
  ov.innerHTML =
    '<div class="tut-box">' +
      '<h2>' + data.title + '</h2>' +
      sectionsHtml +
      '<button class="btn accent tut-close" onclick="this.closest(\'.tut-overlay\').remove()">' +
        closeLabel +
      '</button>' +
    '</div>';

  /* Close on backdrop click */
  ov.addEventListener('click', function (e) {
    if (e.target === ov) ov.remove();
  });

  document.body.appendChild(ov);
}

/* ============================================================
   PH·ªéM TUTORIAL DATA
   ============================================================ */
TUT.ph = {
  vi: {
    title: 'üìñ C√°ch ch∆°i Ph·ªèm (T√° L·∫£)',
    sections: [
      { h: 'M·ª•c ti√™u', p: 'Gom b√†i th√†nh c√°c b·ªô (ph·ªèm), gi·∫£m ƒëi·ªÉm r√°c v·ªÅ 0. H·∫øt r√°c tr∆∞·ªõc ‚Üí √ô (th·∫Øng ngay). Cu·ªëi v√°n ai √≠t ƒëi·ªÉm r√°c nh·∫•t th·∫Øng.' },
      { h: 'B·ªô b√†i h·ª£p l·ªá (Ph·ªèm)', items: [
        'üî¢ S·∫£nh ‚Äî 3+ l√° li√™n ti·∫øp c√πng ch·∫•t (v√≠ d·ª• 5‚ô• 6‚ô• 7‚ô•)',
        'üë• B·ªô ‚Äî 3 l√° ho·∫∑c 4 l√° c√πng s·ªë (v√≠ d·ª• 8‚ô† 8‚ô¶ 8‚ô•)'
      ]},
      { h: 'Lu·∫≠t b√†i', p: 'M·ªói ng∆∞·ªùi ƒë∆∞·ª£c chia 9 l√° (ng∆∞·ªùi ƒëi ƒë·∫ßu 10 l√°). Ng∆∞·ªùi ƒë·∫ßu ƒë√°nh 1 l√° ra b√†n.' },
      { h: 'L∆∞·ª£t ch∆°i', items: [
        '1. Ch·ªçn ƒÇN l√° v·ª´a b·ªã ƒë√°nh (n·∫øu t·∫°o ƒë∆∞·ª£c ph·ªèm) ho·∫∑c B·ªêC t·ª´ n·ªçc',
        '2. ƒê√°nh 1 l√° ra b√†n',
        '3. N·∫øu tay kh√¥ng c√≤n r√°c ‚Üí √ô, th·∫Øng ngay!'
      ]},
      { h: 'T√≠nh ƒëi·ªÉm r√°c', items: [
        'A = 1 ƒëi·ªÉm ¬∑ J/Q/K = 10 ƒëi·ªÉm ¬∑ s·ªë = ƒë√∫ng m·∫∑t s·ªë',
        'L√° n·∫±m ngo√†i ph·ªèm t√≠nh l√† r√°c',
        'Sau 4 v√≤ng ho·∫∑c khi √ô ‚Üí t√≠nh ƒëi·ªÉm, ai √≠t r√°c nh·∫•t th·∫Øng'
      ]}
    ]
  }
}; /* end TUT.xd.vi ‚Äî this block was xd's old ph tutorial, removed */

/* TUT.ph added below as top-level key */
TUT.ph = {
  vi: {
    title: 'üìñ C√°ch ch∆°i Ph·ªèm ¬∑ T√° L·∫£',
    sections: [
      { h: 'M·ª•c ti√™u', p: 'T·∫°o th√†nh c√°c Ph·ªèm (b·ªô b√†i h·ª£p l·ªá) ƒë·ªÉ gi·∫£m ƒëi·ªÉm r√°c xu·ªëng 0. Sau 4 v√≤ng, ai √≠t r√°c nh·∫•t th·∫Øng.' },
      { h: 'Ph·ªèm h·ª£p l·ªá', items: [
        'üî¢ S·∫£nh (Sequence) ‚Äî 3+ l√° li√™n ti·∫øp c√πng ch·∫•t (vd: 5‚ô• 6‚ô• 7‚ô•)',
        'üë• B·ªô (Group) ‚Äî 3 ho·∫∑c 4 l√° c√πng s·ªë (vd: 8‚ô† 8‚ô¶ 8‚ô•)'
      ]},
      { h: 'Chia b√†i', p: 'M·ªói ng∆∞·ªùi 9 l√°, ng∆∞·ªùi ƒë·∫ßu ti√™n nh·∫≠n 10 l√° v√† ƒë√°nh ra 1 l√° ngay.' },
      { h: 'Th·ª© t·ª± l∆∞·ª£t', items: [
        '1. ƒÇN l√° v·ª´a ƒë√°nh (n·∫øu t·∫°o ƒë∆∞·ª£c Ph·ªèm) HO·∫∂C B·ªêC b√†i t·ª´ N·ªçc',
        '2. ƒê√ÅNH m·ªôt l√° ra',
        '3. N·∫øu kh√¥ng c√≤n r√°c ‚Üí √ôU, th·∫Øng ngay!'
      ]},
      { h: 'T√≠nh ƒëi·ªÉm r√°c', items: [
        'A = 1 ƒëi·ªÉm ¬∑ 2‚Äì9 = m·∫∑t s·ªë ¬∑ 10/J/Q/K = 10 ƒëi·ªÉm',
        'B√†i kh√¥ng n·∫±m trong Ph·ªèm = r√°c',
        '√çt r√°c nh·∫•t sau 4 v√≤ng ‚Üí th·∫Øng'
      ]}
    ]
  },
  en: {
    title: 'üìñ How to Play Phom (Ta La)',
    sections: [
      { h: 'Goal', p: 'Form sets (phom) to reduce deadwood to zero. After 4 rounds, fewest deadwood points wins.' },
      { h: 'Valid sets', items: [
        'üî¢ Sequence ‚Äî 3+ consecutive cards of the same suit (e.g. 5‚ô• 6‚ô• 7‚ô•)',
        'üë• Group ‚Äî 3 or 4 cards of same rank (e.g. 8‚ô† 8‚ô¶ 8‚ô•)'
      ]},
      { h: 'Deal', p: 'Each player gets 9 cards; first player gets 10 and discards one immediately.' },
      { h: 'Turn order', items: [
        '1. TAKE the last discarded card (if it completes a set) OR DRAW from deck',
        '2. DISCARD one card',
        '3. No deadwood left ‚Üí Phom out, instant win!'
      ]},
      { h: 'Deadwood scoring', items: [
        'A = 1 pt ¬∑ 2‚Äì9 = face value ¬∑ 10/J/Q/K = 10 pts',
        'Cards not in a set = deadwood',
        'Fewest deadwood points after 4 rounds wins'
      ]}
    ]
  }
};
document.addEventListener('DOMContentLoaded', function () {
  updateThemeBtns();
  applyLang();
  checkContinue();
});
</script>
</body>
</html>
